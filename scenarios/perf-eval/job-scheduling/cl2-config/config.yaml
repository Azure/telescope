name: job-scheduling

{{$job_count := DefaultParam .CL2_JOB_COUNT 20000}}

namespace:
  number: 1
  prefix: resource-consumer
  deleteStaleNamespaces: true
  deleteAutomanagedNamespaces: true
  enableExistingNamespaces: false

tuningSets:
- name: Uniform1qps
  qpsLoad:
    qps: 1

steps:
  - name: Start measurements
    measurements:
      - Identifier: Start JobLifecycleLatency
        Method: JobLifecycleLatency
        Params:
          action: start
          timeout: 1h
          labelSelector: perf_test=true
      - Identifier: Start WaitForFinishedJobs
        Method: WaitForFinishedJobs
        Params:
          action: start
          timeout: 1h
          labelSelector: perf_test=true

  {{range $i := Loop $job_count}}
  - name: Create job {{$i}}
    phases:
    - namespaceRange:
          min: 1
          max: 1
      replicasPerNamespace: 1
      tuningSet: Uniform1qps
      objectBundle:
      - basename: test-job-{{$i}}
        objectTemplatePath: deployment_template.yaml
  {{end}}

  - name: Waiting for jobs to be finished
    measurements:
      - Identifier: Gather WaitForFinishedJobs
        Method: WaitForFinishedJobs
        Params:
          action: gather
        
  - name: Collect measurements
      - Identifier: Gather JobLifecycleLatency
        Method: JobLifecycleLatency
        Params:
          action: gather
