apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: zfs-host-setup
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: zfs-host-setup
  template:
    metadata:
      labels:
        name: zfs-host-setup
    spec:
      nodeSelector:
        fio-dedicated: "true"
      hostNetwork: true
      hostPID: true
      containers:
        - name: zfs-host-setup
          image: ubuntu:22.04
          securityContext:
            privileged: true
          volumeMounts:
            - name: host-root
              mountPath: /host
          command:
            - bash
            - -c
            - |
              set -euo pipefail
              # Collect NVMe disks excluding the first (nvme0n1) which is typically the OS disk
              NVME_DISKS=$(ls /dev/nvme*n1 2>/dev/null | grep -v '/dev/nvme0n1' || true)
              echo "Starting ZFS setup on node $(hostname)..."
              echo "Disks selected for ZFS (excluding nvme0n1): ${NVME_DISKS:-<none>}"

              echo "Updating package repository on the host..."
              chroot /host apt update

              echo "Installing required packages on the host..."
              chroot /host apt install -y gdisk zfsutils-linux kmod

              echo "Checking if ZFS pool 'zfspv-pool' already exists on the host..."
              if chroot /host zpool list | grep -q zfspv-pool; then
                echo "ZFS pool 'zfspv-pool' already exists. Skipping disk setup."
              else
                if [ -z "$NVME_DISKS" ]; then
                  echo "No additional NVMe disks (excluding nvme0n1) found. Skipping pool creation."
                else
                  echo "ZFS pool does not exist. Proceeding with disk setup on the host..."
                  for disk in $NVME_DISKS; do
                    echo "Preparing disk $disk..."
                    if [ -e "$disk" ]; then
                      chroot /host sgdisk --zap-all "$disk"
                      chroot /host sgdisk --new=1:0:0 "$disk"
                    else
                      echo "Disk $disk not found. Skipping."
                    fi
                  done

                  echo "Loading ZFS kernel module on the host..."
                  chroot /host modprobe zfs

                  echo "Creating ZFS pool 'zfspv-pool' on the host with disks: $NVME_DISKS"
                  chroot /host zpool create zfspv-pool $NVME_DISKS || echo "Failed to create ZFS pool."
                fi
              fi

              echo "Disabling ZFS primarycache and secondarycache on the host..."
              chroot /host zfs set primarycache=none zfspv-pool || echo "Failed to set primarycache."
              chroot /host zfs set secondarycache=none zfspv-pool || echo "Failed to set secondarycache."
              echo "ZFS setup complete. Keeping pod running..."
              sleep inf
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "chroot /host zpool status zfspv-pool || exit 1"
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: host-root
          hostPath:
            path: /
      tolerations:
        - operator: Exists
          effect: NoExecute
        - operator: Exists
          effect: NoSchedule
