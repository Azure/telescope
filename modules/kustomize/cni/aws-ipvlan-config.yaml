kind: DaemonSet
apiVersion: apps/v1
metadata:
  name: ipvlan-config
  namespace: cni
  labels:
    app: ipvlan
spec:
  selector:
    matchLabels:
      app: ipvlan
  template:
    metadata:
      labels:
        app: ipvlan
    spec:
      priorityClassName: "system-node-critical"
      tolerations:
        - operator: "Exists"
      hostNetwork: true
      containers:
        - name: config
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              set -eo pipefail
              echo "Writing chained CNI configuration..."

              # List existing CNI configurations
              ls -la /etc/cni
              ls -la /etc/cni/net.d/
              ls -ls /etc/multus/cni/net.d/ || true

              # Write the chained ipvlan CNI configuration
              cat > /etc/cni/net.d/00-cni-ipvlan.conflist << 'EOF'
              {
                  "cniVersion": "0.4.0",
                  "name": "cni-ipvlan-vpc-k8s",
                  "plugins": 
                [
                  {
                    "cniVersion": "0.4.0",
                    "type": "cni-ipvlan-vpc-k8s-ipam",
                    "interfaceIndex": 1,
                    "secGroupIds": 
                      [
                        "sg-0fb721c543cd384a9"
                      ]
                  },
                  {
                    "cniVersion": "0.4.0",
                    "type": "cni-ipvlan-vpc-k8s-ipvlan",
                    "mode": "l2"
                  },
                  {
                    "cniVersion": "0.4.0",
                    "type": "cni-ipvlan-vpc-k8s-unnumbered-ptp",
                    "hostInterface": "ens5",
                    "containerInterface": "eth1",
                    "ipMasq": true
                  }
                  ]
              }
              EOF

              echo "CNI configuration written successfully"
              cat /etc/cni/net.d/00-cni-ipvlan.conflist
              sleep infinity
          volumeMounts:
            - name: cni-config
              mountPath: /etc/cni
          securityContext:
            runAsUser: 0
            privileged: true
            capabilities:
              add: ["NET_ADMIN"]
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  if [ -f /etc/cni/net.d/00-cni-ipvlan.conflist ]; then
                    exit 0
                  else
                    exit 1
                  fi
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: cni-config
          hostPath:
            path: /etc/cni
            type: Directory
