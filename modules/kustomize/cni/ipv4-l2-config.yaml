apiVersion: v1
kind: Pod
metadata:
  name: ipv4-node1
  namespace: default
  labels:
    app: ipv4
spec:
  nodeSelector:
    kubernetes.io/hostname: aks-default-22830941-vms1
  tolerations:
    - key: "node.kubernetes.io/not-ready"
      operator: "Exists"
  hostNetwork: true
  containers:
    - name: config
      image: alpine:latest
      command:
        - /bin/sh
        - -c
        - |
          set -eo pipefail
          echo "Writing ipvlan CNI configuration..."

          # List existing CNI configurations
          ls -la /etc/cni
          ls -la /etc/cni/net.d/
          ls -ls /etc/multus/cni/net.d/ || true

          # Write the ipvlan CNI configuration
          cat > /etc/cni/net.d/01-ipv4-l2.conflist << 'EOF'
          {
              "cniVersion": "0.3.1",
              "name": "ipv4-l2",
              "plugins":
              [
                  {
                      "cniVersion": "0.3.1",
                      "type": "ipvlan",
                      "master": "eth0",
                      "linkInContainer": false,
                      "mode": "l2",
                      "ipam": {
                          "type": "host-local",
                          "ranges": [
                              [
                                  {
                                      "subnet": "10.224.0.16/28",
                                      "rangeStart": "10.224.0.17",
                                      "rangeEnd": "10.224.0.30"
                                  }
                              ]
                          ],
                          "routes": [
                              { "dst": "0.0.0.0/0" }
                          ]
                      }
                  },
                  {
                      "cniVersion": "0.3.1",
                      "name": "ptp-masq",
                      "type": "ptp",
                      "ipMasq": true,
                      "ipam": {}
                  }
              ]
          }
          EOF

          echo "CNI configuration written successfully"
          cat /etc/cni/net.d/01-ipv4-l2.conflist
          exit 0
      volumeMounts:
        - name: cni-config
          mountPath: /etc/cni
      securityContext:
        runAsUser: 0
        privileged: true
        capabilities:
          add: ["NET_ADMIN"]
  volumes:
    - name: cni-config
      hostPath:
        path: /etc/cni
        type: Directory
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: ipv4-node2
  namespace: default
  labels:
    app: ipv4
spec:
  nodeSelector:
    kubernetes.io/hostname: aks-default-22830941-vms2
  tolerations:
    - key: "node.kubernetes.io/not-ready"
      operator: "Exists"
  hostNetwork: true
  containers:
    - name: config
      image: alpine:latest
      command:
        - /bin/sh
        - -c
        - |
          set -eo pipefail
          echo "Writing ipvlan CNI configuration..."

          # List existing CNI configurations
          ls -la /etc/cni
          ls -la /etc/cni/net.d/
          ls -ls /etc/multus/cni/net.d/ || true

          # Write the ipvlan CNI configuration
          cat > /etc/cni/net.d/01-ipv4-l2.conflist << 'EOF'
          {
              "cniVersion": "0.3.1",
              "name": "ipv4-l2",
              "plugins":
              [
                  {
                      "cniVersion": "0.3.1",
                      "type": "ipvlan",
                      "master": "eth0",
                      "linkInContainer": false,
                      "mode": "l2",
                      "ipam": {
                          "type": "host-local",
                          "ranges": [
                              [
                                  {
                                      "subnet": "10.224.0.32/28",
                                      "rangeStart": "10.224.0.33",
                                      "rangeEnd": "10.224.0.46"
                                  }
                              ]
                          ],
                          "routes": [
                              { "dst": "0.0.0.0/0" }
                          ]
                      }
                  },
                  {
                      "cniVersion": "0.3.1",
                      "name": "ptp-masq",
                      "type": "ptp",
                      "ipMasq": true,
                      "ipam": {}
                  }
              ]
          }
          EOF

          echo "CNI configuration written successfully"
          cat /etc/cni/net.d/01-ipv4-l2.conflist
          exit 0
      volumeMounts:
        - name: cni-config
          mountPath: /etc/cni
      securityContext:
        runAsUser: 0
        privileged: true
        capabilities:
          add: ["NET_ADMIN"]
  volumes:
    - name: cni-config
      hostPath:
        path: /etc/cni
        type: Directory
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: ipv4-node3
  namespace: default
  labels:
    app: ipv4
spec:
  nodeSelector:
    kubernetes.io/hostname: aks-default-22830941-vms3
  tolerations:
    - key: "node.kubernetes.io/not-ready"
      operator: "Exists"
  hostNetwork: true
  containers:
    - name: config
      image: alpine:latest
      command:
        - /bin/sh
        - -c
        - |
          set -eo pipefail
          echo "Writing ipvlan CNI configuration..."

          # List existing CNI configurations
          ls -la /etc/cni
          ls -la /etc/cni/net.d/
          ls -ls /etc/multus/cni/net.d/ || true

          # Write the ipvlan CNI configuration
          cat > /etc/cni/net.d/01-ipv4-l2.conflist << 'EOF'
          {
              "cniVersion": "0.3.1",
              "name": "ipv4-l2",
              "plugins":
              [
                  {
                      "cniVersion": "0.3.1",
                      "type": "ipvlan",
                      "master": "eth0",
                      "linkInContainer": false,
                      "mode": "l2",
                      "ipam": {
                          "type": "host-local",
                          "ranges": [
                              [
                                  {
                                      "subnet": "10.224.0.48/28",
                                      "rangeStart": "10.224.0.49",
                                      "rangeEnd": "10.224.0.62"
                                  }
                              ]
                          ],
                          "routes": [
                              { "dst": "0.0.0.0/0" }
                          ]
                      }
                  },
                  {
                      "cniVersion": "0.3.1",
                      "name": "ptp-masq",
                      "type": "ptp",
                      "ipMasq": true,
                      "ipam": {}
                  }
              ]
          }
          EOF

          echo "CNI configuration written successfully"
          cat /etc/cni/net.d/01-ipv4-l2.conflist
          exit 0
      volumeMounts:
        - name: cni-config
          mountPath: /etc/cni
      securityContext:
        runAsUser: 0
        privileged: true
        capabilities:
          add: ["NET_ADMIN"]
  volumes:
    - name: cni-config
      hostPath:
        path: /etc/cni
        type: Directory
  restartPolicy: Never