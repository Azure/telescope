apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  namespace: default
  name: nccl-tests
  labels:
    app: nccl-tests
spec:
  slotsPerWorker: {{slots_per_worker}}
  runPolicy:
    cleanPodPolicy: Running
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        metadata:
          labels:
            app: nccl-tests
            component: launcher
        spec:
          restartPolicy: OnFailure
          containers:
            - name: nccl-launcher
              image: public.ecr.aws/hpc-cloud/nccl-tests:latest
              imagePullPolicy: IfNotPresent
              env:
                - name: PATH
                  value: $PATH:/opt/amazon/efa/bin:/usr/bin
                - name: LD_LIBRARY_PATH
                  value: /opt/amazon/openmpi/lib:/opt/nccl/build/lib:/opt/amazon/efa/lib:/opt/aws-ofi-nccl/install/lib:/usr/local/nvidia/lib:$LD_LIBRARY_PATH
                - name: NCCL_BUFFSIZE
                  value: "8388608"
                - name: NCCL_P2P_NET_CHUNKSIZE
                  value: "524288"
                - name: NCCL_TUNER_PLUGIN
                  value: /opt/aws-ofi-nccl/install/lib/libnccl-ofi-tuner.so
                - name: OMPI_ALLOW_RUN_AS_ROOT
                  value: "1"
                - name: OMPI_ALLOW_RUN_AS_ROOT_CONFIRM
                  value: "1"
                - name: NUMBER_OF_PROCESSES
                  value: "{{number_of_processes}}"
              command:
                - /bin/bash
                - -c
              args:
                - |
                  /opt/amazon/openmpi/bin/mpirun \
                    -np ${NUMBER_OF_PROCESSES} \
                    -bind-to none \
                    -x PATH \
                    -x LD_LIBRARY_PATH \
                    -x NCCL_BUFFSIZE \
                    -x NCCL_P2P_NET_CHUNKSIZE \
                    -x NCCL_TUNER_PLUGIN \
                    -x FI_EFA_USE_DEVICE_RDMA=1 \
                    -x RDMAV_FORK_SAFE=1 \
                    --mca pml ^cm,ucx \
                    --mca btl tcp,self \
                    --mca btl_tcp_if_exclude lo,docker0,veth_def_agent \
                    /opt/nccl-tests/build/all_reduce_perf \
                      -b 8 \
                      -e 8G \
                      -f 2 \
                      -g 1 \
                      -n 40
    Worker:
      replicas: {{replicas}}
      template:
        metadata:
          labels:
            app: nccl-tests
            component: worker
        spec:
          containers:
            - name: nccl-worker
              image: public.ecr.aws/hpc-cloud/nccl-tests:latest
              imagePullPolicy: IfNotPresent
              resources:
                limits:
                  nvidia.com/gpu: {{gpu_allocatable}}
                  vpc.amazonaws.com/efa: {{efa_allocatable}}
                requests:
                  nvidia.com/gpu: {{gpu_allocatable}}
                  vpc.amazonaws.com/efa: {{efa_allocatable}}
              volumeMounts:
                - name: shmem
                  mountPath: /dev/shm
          volumes:
            - name: shmem
              hostPath:
                path: /dev/shm
