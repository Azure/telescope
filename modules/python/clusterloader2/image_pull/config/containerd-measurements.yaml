---
{{$action := .action}}
steps:
  - name: {{$action}} Containerd Measurements
    measurements:
      # ContainerdCriImagePullingThroughput - WORKS (has histogram buckets)
      - identifier: ContainerdCriImagePullingThroughput
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriImagePullingThroughput
          metricVersion: v1
          unit: MB/s
          queries:
            - name: Perc100
              query: histogram_quantile(1, sum(rate(containerd_cri_image_pulling_throughput_bucket{nodepool=~"userpool.*"}[%v])) by (le))
            - name: Perc99
              query: histogram_quantile(0.99, sum(rate(containerd_cri_image_pulling_throughput_bucket{nodepool=~"userpool.*"}[%v])) by (le))
            - name: Perc90
              query: histogram_quantile(0.90, sum(rate(containerd_cri_image_pulling_throughput_bucket{nodepool=~"userpool.*"}[%v])) by (le))
            - name: Perc50
              query: histogram_quantile(0.50, sum(rate(containerd_cri_image_pulling_throughput_bucket{nodepool=~"userpool.*"}[%v])) by (le))
            - name: Sum
              query: sum(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"})
            - name: Count
              query: sum(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"})
            - name: Average
              query: sum(rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum(rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))

      # ContainerdCriNetworkPluginOperations - Sum/Count only (histograms may not work)
      - identifier: ContainerdCriNetworkPluginOperations
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriNetworkPluginOperations
          metricVersion: v1
          unit: s
          dimensions:
            - operation_type
          queries:
            - name: Sum
              query: sum(containerd_cri_network_plugin_operations_duration_seconds_seconds_sum{nodepool=~"userpool.*"}) by (operation_type)
            - name: Count
              query: sum(containerd_cri_network_plugin_operations_duration_seconds_seconds_count{nodepool=~"userpool.*"}) by (operation_type)
            - name: Average
              query: sum(rate(containerd_cri_network_plugin_operations_duration_seconds_seconds_sum{nodepool=~"userpool.*"}[%v])) by (operation_type) / sum(rate(containerd_cri_network_plugin_operations_duration_seconds_seconds_count{nodepool=~"userpool.*"}[%v])) by (operation_type)

      # ContainerdCriSandboxCreateNetwork - Sum/Count only
      - identifier: ContainerdCriSandboxCreateNetwork
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriSandboxCreateNetwork
          metricVersion: v1
          unit: s
          queries:
            - name: Sum
              query: sum(containerd_cri_sandbox_create_network_seconds_sum{nodepool=~"userpool.*"})
            - name: Count
              query: sum(containerd_cri_sandbox_create_network_seconds_count{nodepool=~"userpool.*"})
            - name: Average
              query: sum(rate(containerd_cri_sandbox_create_network_seconds_sum{nodepool=~"userpool.*"}[%v])) / sum(rate(containerd_cri_sandbox_create_network_seconds_count{nodepool=~"userpool.*"}[%v]))

      # ContainerdCriSandboxDeleteNetwork - Sum/Count only
      - identifier: ContainerdCriSandboxDeleteNetwork
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriSandboxDeleteNetwork
          metricVersion: v1
          unit: s
          queries:
            - name: Sum
              query: sum(containerd_cri_sandbox_delete_network_seconds_sum{nodepool=~"userpool.*"})
            - name: Count
              query: sum(containerd_cri_sandbox_delete_network_seconds_count{nodepool=~"userpool.*"})
            - name: Average
              query: sum(rate(containerd_cri_sandbox_delete_network_seconds_sum{nodepool=~"userpool.*"}[%v])) / sum(rate(containerd_cri_sandbox_delete_network_seconds_count{nodepool=~"userpool.*"}[%v]))
