{{$action := .action}}

steps:
  - name: {{$action}} Containerd Measurements
    measurements:
      - identifier: ContainerdCriImagePullingThroughput
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriImagePullingThroughput
          metricVersion: v1
          unit: MB/s
          queries:
            - name: Perc99
              query: histogram_quantile(0.99, sum(rate(containerd_cri_image_pulling_throughput_bucket{nodepool=~"userpool.*"}[%v])) by (le))
            - name: Perc90
              query: histogram_quantile(0.90, sum(rate(containerd_cri_image_pulling_throughput_bucket{nodepool=~"userpool.*"}[%v])) by (le))
            - name: Perc50
              query: histogram_quantile(0.50, sum(rate(containerd_cri_image_pulling_throughput_bucket{nodepool=~"userpool.*"}[%v])) by (le))
            - name: Sum
              query: sum(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"})
            - name: Count
              query: sum(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"})
      - identifier: ContainerdCriNetworkPluginOperations
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriNetworkPluginOperations
          metricVersion: v1
          unit: s
          dimensions:
            - operation_type
          queries:
            - name: Sum
              query: sum(containerd_cri_network_plugin_operations_duration_seconds_seconds_sum{nodepool=~"userpool.*"}) by (operation_type)
            - name: Count
              query: sum(containerd_cri_network_plugin_operations_duration_seconds_seconds_count{nodepool=~"userpool.*"}) by (operation_type)
      - identifier: ContainerdCriSandboxCreateNetwork
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriSandboxCreateNetwork
          metricVersion: v1
          unit: s
          queries:
            - name: Sum
              query: sum(containerd_cri_sandbox_create_network_seconds_sum{nodepool=~"userpool.*"})
            - name: Count
              query: sum(containerd_cri_sandbox_create_network_seconds_count{nodepool=~"userpool.*"})
      - identifier: ContainerdCriSandboxDeleteNetwork
        method: GenericPrometheusQuery
        params:
          action: {{$action}}
          metricName: ContainerdCriSandboxDeleteNetwork
          metricVersion: v1
          unit: s
          queries:
            - name: Sum
              query: sum(containerd_cri_sandbox_delete_network_seconds_sum{nodepool=~"userpool.*"})
            - name: Count
              query: sum(containerd_cri_sandbox_delete_network_seconds_count{nodepool=~"userpool.*"})
