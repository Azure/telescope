{{$action := .action}} # start, gather

steps:
  - name: {{$action}} Containerd Measurements
    measurements:
    - Identifier: ContainerdCriSandboxCreateNetwork
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: ContainerdCriSandboxCreateNetwork
        metricVersion: v1
        unit: s
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(containerd_cri_sandbox_create_network_seconds_bucket[%v:])) by (le))
          threshold: 5
        - name: Perc90
          query: histogram_quantile(0.90, sum(rate(containerd_cri_sandbox_create_network_seconds_bucket[%v:])) by (le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(containerd_cri_sandbox_create_network_seconds_bucket[%v:])) by (le))
        - name: Sum
          query: sum(containerd_cri_sandbox_create_network_seconds_sum)
        - name: Count
          query: sum(containerd_cri_sandbox_create_network_seconds_count)
    - Identifier: ContainerdCriSandboxRuntimeCreate
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: ContainerdCriSandboxRuntimeCreate
        metricVersion: v1
        unit: s
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(containerd_cri_sandbox_runtime_create_seconds_bucket[%v])) by (le))
        - name: Perc90
          query: histogram_quantile(0.90, sum(rate(containerd_cri_sandbox_runtime_create_seconds_bucket[%v])) by (le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(containerd_cri_sandbox_runtime_create_seconds_bucket[%v])) by (le))
        - name: Sum
          query: sum(containerd_cri_sandbox_runtime_create_seconds_sum)
        - name: Count
          query: sum(containerd_cri_sandbox_runtime_create_seconds_count)
    - Identifier: ContainerdCriNetworkPluginOperations
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: ContainerdCriNetworkPluginOperations
        metricVersion: v1
        unit: s
        dimensions:
          - operation_type
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(containerd_cri_network_plugin_operations_duration_seconds_seconds_bucket[%v])) by (operation_type, le))
        - name: Perc90
          query: histogram_quantile(0.90, sum(rate(containerd_cri_network_plugin_operations_duration_seconds_seconds_bucket[%v])) by (operation_type, le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(containerd_cri_network_plugin_operations_duration_seconds_seconds_bucket[%v])) by (operation_type, le))
        - name: Sum
          query: sum(containerd_cri_network_plugin_operations_duration_seconds_seconds_sum) by (operation_type)
        - name: Count
          query: sum(containerd_cri_network_plugin_operations_duration_seconds_seconds_count) by (operation_type)
