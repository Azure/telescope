{{$action := .action}} # start, gather

steps:
  - name: {{$action}} Additional Measurements
    measurements:
    - Identifier: CESQueueingDelay
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: CES Queue Delay
        metricVersion: v1
        unit: s
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_operator_ces_queueing_delay_seconds_bucket[%v:])) by (le))
        - name: Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_operator_ces_queueing_delay_seconds_bucket[%v:])) by (le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_operator_ces_queueing_delay_seconds_bucket[%v:])) by (le))
    - Identifier: CiliumEndpointPropagationDelay
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Endpoint Propagation Delay
        metricVersion: v1
        unit: s
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_endpoint_propagation_delay_seconds_bucket[%v:])) by (le))
        - name: Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_endpoint_propagation_delay_seconds_bucket[%v:])) by (le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_endpoint_propagation_delay_seconds_bucket[%v:])) by (le))
    - Identifier: CiliumAvgCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Average CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumMaxCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Max CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumAvgMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Avg Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumMaxMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Max Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumOperatorAvgCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Avg CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumOperatorMaxCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Max CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumOperatorMaxMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Max Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumOperatorAvgMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Avg Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    
    # Cilium API Rate Limiter Metrics
    - Identifier: CiliumAgentAPIProcessTime
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Agent API Process Time
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        # PUT
        - name: PUT_Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="PUT", pod="cilium-plmxj"}[%v:])) by (le))
        - name: PUT_Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="PUT", pod="cilium-plmxj"}[%v:])) by (le))
        - name: PUT_Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="PUT", pod="cilium-plmxj"}[%v:])) by (le))
        - name: PUT_Avg
          query: avg(rate(cilium_agent_api_process_time_seconds_sum{method="PUT", pod="cilium-plmxj"}[%v:])) / avg(rate(cilium_agent_api_process_time_seconds_count{method="PUT", pod="cilium-plmxj"}[%v:]))
        - name: PUT_Total
          query: sum(rate(cilium_agent_api_process_time_seconds_sum{method="PUT", pod="cilium-plmxj"}[%v:]))
        - name: PUT_Max
          query: max(histogram_quantile(1.0, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="PUT", pod="cilium-plmxj"}[%v:])) by (le)))
        - name: PUT_Requests
          query: sum(increase(cilium_agent_api_process_time_seconds_count{method="PUT", pod="cilium-plmxj"}[%v:]))
        - name: PUT_TotalTime
          query: sum(increase(cilium_agent_api_process_time_seconds_sum{method="PUT", pod="cilium-plmxj"}[%v:]))
        # DELETE
        - name: DELETE_Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="DELETE", pod="cilium-plmxj"}[%v:])) by (le))
        - name: DELETE_Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="DELETE", pod="cilium-plmxj"}[%v:])) by (le))
        - name: DELETE_Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="DELETE", pod="cilium-plmxj"}[%v:])) by (le))
        - name: DELETE_Avg
          query: avg(rate(cilium_agent_api_process_time_seconds_sum{method="DELETE", pod="cilium-plmxj"}[%v:])) / avg(rate(cilium_agent_api_process_time_seconds_count{method="DELETE", pod="cilium-plmxj"}[%v:]))
        - name: DELETE_Total
          query: sum(rate(cilium_agent_api_process_time_seconds_sum{method="DELETE", pod="cilium-plmxj"}[%v:]))
        - name: DELETE_Max
          query: max(histogram_quantile(1.0, sum(rate(cilium_agent_api_process_time_seconds_bucket{method="DELETE", pod="cilium-plmxj"}[%v:])) by (le)))
        - name: DELETE_Requests
          query: sum(increase(cilium_agent_api_process_time_seconds_count{method="DELETE", pod="cilium-plmxj"}[%v:]))
        - name: DELETE_TotalTime
          query: sum(increase(cilium_agent_api_process_time_seconds_sum{method="DELETE", pod="cilium-plmxj"}[%v:]))
        # OVERALL
        - name: Overall_Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_agent_api_process_time_seconds_bucket{pod="cilium-plmxj"}[%v:])) by (le))
        - name: Overall_Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_agent_api_process_time_seconds_bucket{pod="cilium-plmxj"}[%v:])) by (le))
        - name: Overall_Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_agent_api_process_time_seconds_bucket{pod="cilium-plmxj"}[%v:])) by (le))
        - name: Overall_Avg
          query: avg(rate(cilium_agent_api_process_time_seconds_sum{pod="cilium-plmxj"}[%v:])) / avg(rate(cilium_agent_api_process_time_seconds_count{pod="cilium-plmxj"}[%v:]))
        - name: Overall_Total
          query: sum(rate(cilium_agent_api_process_time_seconds_sum{pod="cilium-plmxj"}[%v:]))
        - name: Overall_Max
          query: max(histogram_quantile(1.0, sum(rate(cilium_agent_api_process_time_seconds_bucket{pod="cilium-plmxj"}[%v:])) by (le)))
        - name: Overall_Requests
          query: sum(increase(cilium_agent_api_process_time_seconds_count{pod="cilium-plmxj"}[%v:]))
        - name: Overall_TotalTime
          query: sum(increase(cilium_agent_api_process_time_seconds_sum{pod="cilium-plmxj"}[%v:]))


    - Identifier: CiliumAPIRateLimiterProcessedRequests
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Processed Requests
        metricVersion: v1
        unit: requests/second
        enableViolations: true
        queries:
        # Endpoint-Create Specific Queries
        - name: EndpointCreate_Total
          query: sum(increase(cilium_api_limiter_processed_requests_total{api_call="endpoint-create", pod="cilium-plmxj"}[%v:]))
        - name: EndpointCreate_Rate
          query: sum(rate(cilium_api_limiter_processed_requests_total{api_call="endpoint-create", pod="cilium-plmxj"}[%v:]))
        - name: EndpointCreate_Success_Total
          query: sum(increase(cilium_api_limiter_processed_requests_total{api_call="endpoint-create", outcome="success", pod="cilium-plmxj"}[%v:]))
        - name: EndpointCreate_Fail_Total
          query: sum(increase(cilium_api_limiter_processed_requests_total{api_call="endpoint-create", outcome="fail", pod="cilium-plmxj"}[%v:]))
        - name: EndpointCreate_Success_Rate
          query: sum(rate(cilium_api_limiter_processed_requests_total{api_call="endpoint-create", outcome="success", pod="cilium-plmxj"}[%v:]))
        - name: EndpointCreate_Fail_Rate
          query: sum(rate(cilium_api_limiter_processed_requests_total{api_call="endpoint-create", outcome="fail", pod="cilium-plmxj"}[%v:]))

        # Endpoint-Delete Specific Queries
        - name: EndpointDelete_Total
          query: sum(increase(cilium_api_limiter_processed_requests_total{api_call="endpoint-delete", pod="cilium-plmxj"}[%v:]))
        - name: EndpointDelete_Rate
          query: sum(rate(cilium_api_limiter_processed_requests_total{api_call="endpoint-delete", pod="cilium-plmxj"}[%v:]))
        - name: EndpointDelete_Success_Total
          query: sum(increase(cilium_api_limiter_processed_requests_total{api_call="endpoint-delete", outcome="success", pod="cilium-plmxj"}[%v:]))
        - name: EndpointDelete_Fail_Total
          query: sum(increase(cilium_api_limiter_processed_requests_total{api_call="endpoint-delete", outcome="fail", pod="cilium-plmxj"}[%v:]))
        - name: EndpointDelete_Success_Rate
          query: sum(rate(cilium_api_limiter_processed_requests_total{api_call="endpoint-delete", outcome="success", pod="cilium-plmxj"}[%v:]))
        - name: EndpointDelete_Fail_Rate
          query: sum(rate(cilium_api_limiter_processed_requests_total{api_call="endpoint-delete", outcome="fail", pod="cilium-plmxj"}[%v:]))

        # Overall Queries
        - name: Overall_Total
          query: sum(increase(cilium_api_limiter_processed_requests_total{pod="cilium-plmxj"}[%v:]))
        - name: Overall_Rate
          query: sum(rate(cilium_api_limiter_processed_requests_total{pod="cilium-plmxj"}[%v:]))


    - Identifier: CiliumAPIRateLimiterProcessingDuration
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Processing Duration in Seconds
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        # Endpoint Create
        - name: EndpointCreate_Mean_Avg_OverTime
          query: avg_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-create", value="mean", pod="cilium-plmxj"}[%v:]) 
        - name: EndpointCreate_Estimated_Avg_OverTime
          query: avg_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-create", value="estimated", pod="cilium-plmxj"}[%v:]) 
        - name: EndpointCreate_Mean_Max_OverTime
          query: max_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-create", value="mean", pod="cilium-plmxj"}[%v:])
        - name: EndpointCreate_Estimated_Max_OverTime
          query: max_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-create", value="estimated", pod="cilium-plmxj"}[%v:])
      # Endpoint Delete
        - name: EndpointDelete_Mean_Avg_OverTime
          query: avg_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-delete", value="mean", pod="cilium-plmxj"}[%v:]) 
        - name: EndpointDelete_Estimated_Avg_OverTime
          query: avg_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-delete", value="estimated", pod="cilium-plmxj"}[%v:]) 
        - name: EndpointDelete_Mean_Max_OverTime
          query: max_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-delete", value="mean", pod="cilium-plmxj"}[%v:]) 
        - name: EndpointDelete_Estimated_Max_OverTime
          query: max_over_time(cilium_api_limiter_processing_duration_seconds{api_call="endpoint-delete", value="estimated", pod="cilium-plmxj"}[%v:]) 
        # Aggregated:
        - name: AllCalls_Mean_Avg_OverTime
          query: avg_over_time(cilium_api_limiter_processing_duration_seconds{value="mean", pod="cilium-plmxj"}[%v:])
        - name: AllCalls_Estimated_Avg_OverTime
          query: avg_over_time(cilium_api_limiter_processing_duration_seconds{value="estimated", pod="cilium-plmxj"}[%v:])


    #TODO: IF required later on
    # - Identifier: CiliumAPIRateLimiterRequestsInFlight
    #   Method: GenericPrometheusQuery
    #   Params:
    #     action: {{$action}}
    #     metricName: Cilium API Rate Limiter Requests In Flight
    #     metricVersion: v1
    #     unit: count
    #     enableViolations: true
    #     queries:
    

    - Identifier: CiliumAPIRateLimiterWaitDuration
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Wait Duration in Seconds
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
      # Endpoint Create
        - name: EndpointCreate_Mean_Avg
          query: avg_over_time(cilium_api_limiter_wait_duration_seconds{value="mean", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])
        - name: EndpointCreate_Max
          query: max_over_time(cilium_api_limiter_wait_duration_seconds{value="max", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])
        - name: EndpointCreate_Min
          query: min_over_time(cilium_api_limiter_wait_duration_seconds{value="min", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])

      # Endpoint Delete
        - name: EndpointDelete_Mean_Avg
          query: avg_over_time(cilium_api_limiter_wait_duration_seconds{value="mean", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])
        - name: EndpointDelete_Max
          query: max_over_time(cilium_api_limiter_wait_duration_seconds{value="max", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])
        - name: EndpointDelete_Min
          query: min_over_time(cilium_api_limiter_wait_duration_seconds{value="min", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])

      # Aggregated Metrics Across All API Calls
        - name: AllCalls_Mean_Avg
          query: avg_over_time(cilium_api_limiter_wait_duration_seconds{value="mean", pod="cilium-plmxj"}[%v:])
        - name: AllCalls_Max
          query: max_over_time(cilium_api_limiter_wait_duration_seconds{value="max", pod="cilium-plmxj"}[%v:])
        - name: AllCalls_Min
          query: min_over_time(cilium_api_limiter_wait_duration_seconds{value="min", pod="cilium-plmxj"}[%v:])


    - Identifier: CiliumAPIRateLimiterRateLimit
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Rate Limit
        metricVersion: v1
        unit: count
        enableViolations: true
        queries:
        # Queries for Endpoint Create
        - name: EndpointCreate_Limit_Avg
          query: avg_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])
        - name: EndpointCreate_Limit_Max
          query: max_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])
        - name: EndpointCreate_Limit_Min
          query: min_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])

        - name: EndpointCreate_Burst_Avg
          query: avg_over_time(cilium_api_limiter_rate_limit{value="burst", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])
        - name: EndpointCreate_Burst_Max
          query: max_over_time(cilium_api_limiter_rate_limit{value="burst", api_call="endpoint-create", pod="cilium-plmxj"}[%v])
        - name: EndpointCreate_Burst_Min
          query: min_over_time(cilium_api_limiter_rate_limit{value="burst", api_call="endpoint-create", pod="cilium-plmxj"}[%v:])

      # Queries for Endpoint Delete
        - name: EndpointDelete_Limit_Avg
          query: avg_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])
        - name: EndpointDelete_Limit_Max
          query: max_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])
        - name: EndpointDelete_Limit_Min
          query: min_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])

        - name: EndpointDelete_Burst_Avg
          query: avg_over_time(cilium_api_limiter_rate_limit{value="burst", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])
        - name: EndpointDelete_Burst_Max
          query: max_over_time(cilium_api_limiter_rate_limit{value="burst", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])
        - name: EndpointDelete_Burst_Min
          query: min_over_time(cilium_api_limiter_rate_limit{value="burst", api_call="endpoint-delete", pod="cilium-plmxj"}[%v:])

      # Global Aggregated Queries Across All API Calls
        - name: AllCalls_Limit_Avg
          query: avg_over_time(cilium_api_limiter_rate_limit{value="limit", pod="cilium-plmxj"}[%v:])
        - name: AllCalls_Limit_Max
          query: max_over_time(cilium_api_limiter_rate_limit{value="limit", pod="cilium-plmxj"}[%v:])
        - name: AllCalls_Limit_Min
          query: min_over_time(cilium_api_limiter_rate_limit{value="limit", pod="cilium-plmxj"}[%v:])

        - name: AllCalls_Burst_Avg
          query: avg_over_time(cilium_api_limiter_rate_limit{value="burst", pod="cilium-plmxj"}[%v:])
        - name: AllCalls_Burst_Max
          query: max_over_time(cilium_api_limiter_rate_limit{value="burst", pod="cilium-plmxj"}[%v:])
        - name: AllCalls_Burst_Min
          query: min_over_time(cilium_api_limiter_rate_limit{value="burst", pod="cilium-plmxj"}[%v:]) 



