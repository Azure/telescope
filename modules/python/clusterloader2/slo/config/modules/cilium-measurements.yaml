{{$action := .action}} # start, gather

steps:
  - name: {{$action}} Additional Measurements
    measurements:
    - Identifier: CESQueueingDelay
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: CES Queue Delay
        metricVersion: v1
        unit: s
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_operator_ces_queueing_delay_seconds_bucket[%v:])) by (le))
        - name: Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_operator_ces_queueing_delay_seconds_bucket[%v:])) by (le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_operator_ces_queueing_delay_seconds_bucket[%v:])) by (le))
    - Identifier: CiliumEndpointPropagationDelay
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Endpoint Propagation Delay
        metricVersion: v1
        unit: s
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_endpoint_propagation_delay_seconds_bucket[%v:])) by (le))
        - name: Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_endpoint_propagation_delay_seconds_bucket[%v:])) by (le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_endpoint_propagation_delay_seconds_bucket[%v:])) by (le))
    - Identifier: CiliumAvgCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Average CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumMaxCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Max CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumAvgMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Avg Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumMaxMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Max Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumOperatorAvgCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Avg CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumOperatorMaxCPUUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Max CPU Usage
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumOperatorMaxMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Max Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumOperatorAvgMemUsage
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Avg Memory Usage
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    
    # Cilium API Rate Limiter Metrics
    - Identifier: CiliumAgentAPIProcessTime
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Agent API Process Time
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Perc99
          query: histogram_quantile(0.99, sum(rate(cilium_agent_api_process_time_seconds_bucket[%v:])) by (le))
        - name: Perc95
          query: histogram_quantile(0.95, sum(rate(cilium_agent_api_process_time_seconds_bucket[%v:])) by (le))
        - name: Perc50
          query: histogram_quantile(0.50, sum(rate(cilium_agent_api_process_time_seconds_bucket[%v:])) by (le))
        - name: Avg
          query: avg(rate(cilium_agent_api_process_time_seconds_sum[%v:])) / avg(rate(cilium_agent_api_process_time_seconds_count[%v:]))
        - name: Total
          query: sum(rate(cilium_agent_api_process_time_seconds_sum[%v:]))
        - name: Max
          query: max(histogram_quantile(1.0, sum(rate(cilium_agent_api_process_time_seconds_bucket[%v:])) by (le)))


    - Identifier: CiliumAPIRateLimiterProcessedRequests
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Processed Requests
        metricVersion: v1
        unit: requests/second
        enableViolations: true
        queries:
        - name: Total
          query: sum(cilium_api_limiter_processed_requests_count)
        - name: Rate
          query: sum(rate(cilium_api_limiter_processed_requests_count[%v:]))


    - Identifier: CiliumAPIRateLimiterProcessingDuration
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Processing Duration in Seconds
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Avg
          query: avg(sum_over_time(cilium_api_limiter_processing_duration_seconds[0][%v]))
        - name: Max
          query: max_over_time(max(cilium_api_limiter_processing_duration_seconds[0])[%v])


    - Identifier: CiliumAPIRateLimiterRequestsInFlight
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Requests In Flight
        metricVersion: v1
        unit: count
        enableViolations: true
        queries:
        - name: Instantaneous
          query: sum(cilium_api_limiter_requests_in_flight)
        - name: MaxOverTimeSum
          query: max_over_time(cilium_api_limiter_requests_in_flight[0][%v:])
        - name: AvgOverTimeSum
          query: avg_over_time(cilium_api_limiter_requests_in_flight[0][%v:])
        - name: SumOverTime
          query: sum_over_time(cilium_api_limiter_requests_in_flight[0][%v:])
        - name: MinOverTimeSum
          query: min_over_time(cilium_api_limiter_requests_in_flight[0][%v:])


    - Identifier: CiliumAPIRateLimiterWaitDuration
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Wait Duration in Seconds
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Avg
          query: avg(cilium_api_limiter_wait_duration_seconds{value="mean", api_call="endpoint-create"}[%v])
        - name: Max
          query: max_over_time(cilium_api_limiter_wait_duration_seconds{value="max", api_call="endpoint-create"}[%v])
        - name: Min
          query: min_over_time(cilium_api_limiter_wait_duration_seconds{value="min", api_call="endpoint-create"}[%v])


    - Identifier: CiliumAPIRateLimiterRateLimit
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium API Rate Limiter Rate Limit
        metricVersion: v1
        unit: count
        enableViolations: true
        queries:
        - name: Avg
          query: avg(avg_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-create"}[%v]))
        - name: Max
          query: max_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-create"}[%v])
        - name: Min
          query: min_over_time(cilium_api_limiter_rate_limit{value="limit", api_call="endpoint-create"}[%v])


