## Input params
# Valid actions: "create", "delete"
{{$actionName := printf "%s objects" .actionName}}
{{$namespaces := .namespaces}}
{{$tuningSet := .tuningSet}}

# Derivative variables
{{$is_deleting := (eq .actionName "delete")}}
{{$operationTimeout := .operationTimeout}}

{{$daemonsets := .daemonsets}}
{{$replicas := .replicas}}
{{$namespaceType := .namespaceType}}
{{$nsBasename := "my-namespace"}}
{{$surge := .surge}}

steps:
- name: Starting measurement for '{{$actionName}}'
  measurements:
  - Method: WaitForControlledPodsRunning
    Instances:
    - Identifier: WaitForRunningDeployments
      Params:
        apiVersion: apps/v1
        kind: Deployment
    Params:
      action: start
      checkIfPodsAreUpdated: true
      labelSelector: group = {{.Group}}
      operationTimeout: {{$operationTimeout}}

- name: {{$actionName}}
  phases:
  - replicasPerNamespace: 1
    tuningSet: {{$tuningSet}}
    objectBundle:
    - basename: {{$nsBasename}}
      objectTemplatePath: namespace_template.yaml
      templateFillMap:
        Name: {{$nsBasename}}
        Type: {{$namespaceType}}

# - name: Sleep
#   measurements:
#   - Identifier: Dummy
#     Method: Sleep
#     Params:
#       action: start
#       duration: 1m

  - namespaceRange:
      min: 0
      max: 0
      basename: {{$nsBasename}}
    replicasPerNamespace: {{$daemonsets}}
    tuningSet: {{$tuningSet}}
    objectBundle:
    - basename: deployment
      objectTemplatePath: deployment_template.yaml
      templateFillMap:
        Replicas: {{$replicas}}
        Group: {{.Group}}
        deploymentLabel: {{.deploymentLabel}}

- name: Waiting for '{{$actionName}}' to be completed
  measurements:
  - Method: WaitForControlledPodsRunning
    Instances:
    - Identifier: WaitForRunningDeployments
    Params:
      action: gather
      refreshInterval: 15s