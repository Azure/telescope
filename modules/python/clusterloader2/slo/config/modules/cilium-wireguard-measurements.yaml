{{$nodes := DefaultParam .CL2_NODES 10}}
{{$action := .action}} # start, gather

tuningSets:
- name: Uniform1qps
  qpsLoad:
    qps: 1

steps:
- name: Start measurements
  measurements:
  - Identifier: WaitForControlledPodsRunning
    Method: WaitForControlledPodsRunning
    Params:
      action: {{$action}}
      apiVersion: apps/v1
      kind: DaemonSet
      labelSelector: app = wireguard-exporter
      operationTimeout: 180s
- name: "Gathering measurement - Peer Count"
  measurements:
  - Identifier: WireGuard_Peer_Count
    Method: GenericPrometheusQuery
    Params:
      action: {{$action}}
      metricName: WireGuard Peer Count
      metricVersion: v1
      enableViolations: true
      unit: peer
      queries:
      - name: peer_count_equal_node_count
        query: (sum(wireguard_peers_total) / {{$nodes}})+1
- name: "Gathering measurement - Node Metrics"
  measurements:
  - Identifier: NodeMaxCPUUsage
    Method: GenericPrometheusQuery
    Params:
      action: {{$action}}
      metricName: Node Max CPU Usage
      metricVersion: v1
      unit: cpu
      enableViolations: true
      queries:
      - name: Perc99
        query: quantile(0.99, 100 -  max_over_time(rate(node_cpu_seconds_total{mode="idle"}[1m])[%v:]) * 100)
      - name: Perc90
        query: quantile(0.90, 100 -  max_over_time(rate(node_cpu_seconds_total{mode="idle"}[1m])[%v:]) * 100)
      - name: Perc50
        query: quantile(0.50, 100 -  max_over_time(rate(node_cpu_seconds_total{mode="idle"}[1m])[%v:]) * 100)
  - Identifier: NodeAvgCPUUsage
    Method: GenericPrometheusQuery
    Params:
      action: {{$action}}
      metricName: Node Average CPU Usage
      metricVersion: v1
      unit: cpu
      enableViolations: true
      queries:
      - name: Perc99
        query: quantile(0.99, 100 -  avg_over_time(rate(node_cpu_seconds_total{mode="idle"}[1m])[%v:]) * 100)
      - name: Perc90
        query: quantile(0.90, 100 -  avg_over_time(rate(node_cpu_seconds_total{mode="idle"}[1m])[%v:]) * 100)
      - name: Perc50
        query: quantile(0.50, 100 -  avg_over_time(rate(node_cpu_seconds_total{mode="idle"}[1m])[%v:]) * 100)
  - Identifier: NodeMaxMemUsage
    Method: GenericPrometheusQuery
    Params:
      action: {{$action}}
      metricName: Node Max Memory Usage
      metricVersion: v1
      unit: MB
      enableViolations: true
      queries:
      - name: Perc99
        query: quantile(0.99,max_over_time((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)[%v:]) / 1024 / 1024)
      - name: Perc90
        query: quantile(0.90,max_over_time((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)[%v:]) / 1024 / 1024)
      - name: Perc50
        query: quantile(0.50,max_over_time((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)[%v:]) / 1024 / 1024)
  - Identifier: NodeAvgMemUsage
    Method: GenericPrometheusQuery
    Params:
      action: {{$action}}
      metricName: Node Avg Memory Usage
      metricVersion: v1
      unit: MB
      enableViolations: true
      queries:
      - name: Perc99
        query: quantile(0.99,avg_over_time((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)[%v:]) / 1024 / 1024)
      - name: Perc90
        query: quantile(0.90,avg_over_time((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)[%v:]) / 1024 / 1024)
      - name: Perc50
        query: quantile(0.50,avg_over_time((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)[%v:]) / 1024 / 1024)
