name: netpol-scale-test

# cluster config
{{$CILIUM_ENABLED := DefaultParam .CL2_CILIUM_ENABLED false}}
{{$CILIUM_ENVOY_ENABLED := DefaultParam .CL2_CILIUM_ENVOY_ENABLED false}}

# test setup config
{{$NUMBER_OF_SERVERS_PER_Group := DefaultParam .CL2_NUMBER_OF_SERVERS_PER_GROUP 2}}
{{$NUMBER_OF_CLIENTS_PER_Group := DefaultParam .CL2_NUMBER_OF_CLIENTS_PER_GROUP 1}}
{{$NUMBER_OF_GROUPS := DefaultParam .CL2_NUMBER_OF_GROUPS 2}}
{{$TARGET_PORT := DefaultParam .CL2_TARGET_PORT 8080}}
{{$TARGET_PORT2 := DefaultParam .CL2_TARGET_PORT2 9090}}
{{$WORKERS_PER_CLIENT := DefaultParam .CL2_WORKERS_PER_CLIENT 5}}
{{$DURATION := DefaultParam .CL2_DURATION 600}}
{{$repeats := DefaultParam .CL2_REPEATS 1}}
{{$Network_Policy_Type := DefaultParam .CL2_NETWORK_POLICY_TYPE "k8s"}}
{{$NET_POLICY_L7_ENABLED := DefaultParam .CL2_NET_POLICY_L7_ENABLED false}}
{{$L3_L4_CNP_TEST := DefaultParam .CL2_L3_L4_CNP_TEST true}}
{{$SOAK_TEST := DefaultParam .CL2_SOAK_TEST false}}
{{$CLIENT_METRICS_GATHERING := DefaultParam .CL2_CLIENT_METRICS_GATHERING false}}
{{$NETWORK_POLICY_ENFORCEMENT_LATENCY_BASELINE := DefaultParam .CL2_NETWORK_POLICY_ENFORCEMENT_LATENCY_BASELINE false}}
{{$NET_POLICY_ENFORCEMENT_LATENCY_TARGET_LABEL_KEY := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LATENCY_TARGET_LABEL_KEY "net-pol-test"}}
{{$NET_POLICY_ENFORCEMENT_LATENCY_TARGET_LABEL_VALUE := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LATENCY_TARGET_LABEL_VALUE "enforcement-latency"}}
{{$NET_POLICY_ENFORCEMENT_LATENCY_NODE_LABEL_KEY := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LATENCY_NODE_LABEL_KEY "test"}}
{{$NET_POLICY_ENFORCEMENT_LATENCY_NODE_LABEL_VALUE := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LATENCY_NODE_LABEL_VALUE "net-policy-client"}}
{{$NET_POLICY_ENFORCEMENT_LATENCY_MAX_TARGET_PODS_PER_NS := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LATENCY_MAX_TARGET_PODS_PER_NS 5}}
{{$NET_POLICY_ENFORCEMENT_LOAD_COUNT := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LOAD_COUNT 0}}
{{$NET_POLICY_ENFORCEMENT_LOAD_QPS := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LOAD_QPS 0}}
{{$NET_POLICY_ENFORCEMENT_LOAD_TARGET_NAME := DefaultParam .CL2_POLICY_ENFORCEMENT_LOAD_TARGET_NAME "small-deployment"}}
{{$CILIUM_POLICY_IMPORTS_ERROR_THRESHOLD := DefaultParam .CL2_CILIUM_POLICY_IMPORTS_ERROR_THRESHOLD 0}}
{{$CILIUM_ENDPOINT_REGEN_FAIL_PERC_THRESHOLD := DefaultParam .CL2_CILIUM_ENDPOINT_REGEN_FAIL_PERC_THRESHOLD 0.01}}
{{$L3_L4_PORT := DefaultParam .CL2_L3_L4_PORT false}}
{{$TARGET_GROUP := DefaultParam .CL2_TARGET_GROUP "service-discovery"}}
{{$NETPOL_ENFORCEMENT_LATENCY := DefaultParam .CL2_ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST true}}

namespace:
  number: {{$NUMBER_OF_GROUPS}}
  prefix: slo
  deleteStaleNamespaces: true
  deleteAutomanagedNamespaces: true
  enableExistingNamespaces: false

{{if $NETPOL_ENFORCEMENT_LATENCY}}
tuningSets:
- name: Uniform1qps
  qpsLoad:
    qps: 1
{{end}}
steps:
# 1. If cilium enabled
#    * start cilium agent metrics 
#    * start cilium envoy metrics 
# 2. start network performance measurement (setup and run)
# 3. gather network performance measurement (wait and gather results)
# 4. gather cilium envoy metrics
# 5. gather cilium agent metrics
# 6. sleep for 5 minutes before deleting the namespaces, to not overload apiserver
  - module:
      path: /modules/measurements.yaml
      params:
        action: start
        group: "service-discovery"
{{if $CILIUM_ENABLED}}
  - module:
      path: /modules/cilium-measurements.yaml
      params:
        action: start

  {{if $CILIUM_ENVOY_ENABLED}}
  - module:
      path: /modules/cilium-envoy-measurements.yaml
      params:
        action: start
  {{end}}
{{end}}

{{if and $CLIENT_METRICS_GATHERING (eq $NETPOL_ENFORCEMENT_LATENCY false)}}
  - module:
      path: /modules/network-policy-client-metrics.yaml
      params:
        action: start
{{end}}


{{if $SOAK_TEST}}
  {{range $i := Loop $repeats}}
  # start network performance measurement
  - name: Network Policy Soak Test - Start
    measurements:
    - Identifier: NetworkPolicySoakMeasurement
      Method: NetworkPolicySoakMeasurement
      Params:
        action: start
        targetLabelKey: app
        targetLabelValue: target
        clientLabelKey: app
        clientLabelValue: client
        targetReplicasPerNs: {{$NUMBER_OF_SERVERS_PER_Group}}
        clientReplicasPerDep: {{$NUMBER_OF_CLIENTS_PER_Group}}
        targetPort: {{$TARGET_PORT}}
        targetPort2: {{$TARGET_PORT2}}
        l7Enabled: {{$NET_POLICY_L7_ENABLED}}
        cnpTestL3L4: {{$L3_L4_CNP_TEST}}
        targetPath: /
        testDuration: "{{$DURATION}}"
        workerPerClient: {{$WORKERS_PER_CLIENT}}
        npType: {{$Network_Policy_Type}}
  - name: Network Policy Soak Test - RestartPods
    measurements:
    - Identifier: NetworkPolicySoakMeasurement
      Method: NetworkPolicySoakMeasurement
      Params:
        action: restart
  # - name: Network Policy Soak Test - Delete CNPS
  #   measurements:
  #   - Identifier: NetworkPolicySoakMeasurement
  #     Method: NetworkPolicySoakMeasurement
  #     Params:
  #       action: delete-ccnps-cnps
  # - name: Network Policy Soak Test - Delete Pods
  #   measurements:
  #   - Identifier: NetworkPolicySoakMeasurement
  #     Method: NetworkPolicySoakMeasurement
  #     Params:
  #       action: delete-pods
  # - name: Sleep
  #   measurements:
  #   - Identifier: Sleep
  #     Method: Sleep
  #     Params:
  #       duration: 2m
  {{end}}
{{end}}

{{if and $CLIENT_METRICS_GATHERING (eq $NETPOL_ENFORCEMENT_LATENCY false)}}
        clientMetricsGatheringEnabled: true
{{end}}

{{if $SOAK_TEST}}
  # 5. gather network performance measurement (wait and gather results)
  - name: Network Policy Soak Test - Gather Results
    measurements:
    - Identifier: NetworkPolicySoakMeasurement
      Method: NetworkPolicySoakMeasurement
      Params:
        action: gather #gather will wait for the soak test to finish   
{{end}} 
{{if and $CLIENT_METRICS_GATHERING (eq $NETPOL_ENFORCEMENT_LATENCY false)}}
  - module:
      path: /modules/network-policy-client-metrics.yaml
      params:
        action: gather
{{end}}
{{if $CILIUM_ENABLED}}
  - module:
      path: /modules/cilium-measurements.yaml
      params:
        action: gather

  {{if $CILIUM_ENVOY_ENABLED}}
  - module:
      path: /modules/cilium-envoy-measurements.yaml
      params:
        action: gather
  {{end}}
{{end}}
  - module:
      path: /modules/measurements.yaml
      params:
        action: gather
        group: "service-discovery"
{{if $NETPOL_ENFORCEMENT_LATENCY}}
# 11. Gather policy enforcement latency metrics
- name: "Gather policy enforcement latency metrics"
  measurements:
  - Identifier: PolicyEnforcementLatencyMetrics
    Method: GenericPrometheusQuery
    Params:
      action: gather
      enableViolations: true
{{end}}
# 6. sleep for 5 minutes before deleting the namespaces, to not overload apiserver
  - name: Sleep
    measurements:
    - Identifier: Sleep
      Method: Sleep
      Params:
        duration: 5m
{{if $NETPOL_ENFORCEMENT_LATENCY}}
- name: "Complete pod creation network policy enforcement latency measurement"
  measurements:
  - Identifier: NetworkPolicyEnforcement
    Method: NetworkPolicyEnforcement
    Params:
      action: complete
      testType: policy-creation
{{end}}
