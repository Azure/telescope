name: deployment-churn

{{$nodesPerStep := DefaultParam .CL2_NODES_PER_STEP 100}}
{{$nodes := DefaultParam .CL2_NODES 1000}}
{{$steps := DivideInt $nodes $nodesPerStep}}
{{$latencyPodCpu := DefaultParam .CL2_LATENCY_POD_CPU 10}}
{{$latencyPodMemory := DefaultParam .CL2_LATENCY_POD_MEMORY 50}}
{{$podStartupLatencyThreshold := DefaultParam .CL2_POD_STARTUP_LATENCY_THRESHOLD "60s"}}
{{$operationTimeout := DefaultParam .CL2_OPERATION_TIMEOUT "120s"}}
{{$groupName := DefaultParam .CL2_GROUP_NAME "deployment-churn"}}

namespace:
  number: 1
  prefix: slo
  deleteStaleNamespaces: true
  deleteAutomanagedNamespaces: true
  enableExistingNamespaces: false

tuningSets:
  - name: DeploymentCreatePNIQps
    qpsLoad:
      qps: 1
  - name: DeploymentCreateQps
    qpsLoad:
      qps: 1


steps:
  - name: Log - steps={{$steps}},  nodes={{$nodes}}, deploymentQPS=1
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 1ms
  {{range $j := Loop $steps}}
  - name: Create PNI -{{$j}}
    phases:
    - namespaceRange:
        min: 1
        max: 1
      replicasPerNamespace: 1
      tuningSet: DeploymentCreatePNIQps
      objectBundle:
      - basename: pod-network-instance-{{$j}}
        objectTemplatePath: pni_static_template.yaml
        templateFillMap:
              ReservationSize: {{$nodesPerStep}}
  - name: Wait for PNI to be created and nodes to be registered -{{$j}}
    measurements:
      - Identifier: Dummy
        Method: Sleep
        Params:
          duration: 60s
  - name: Starting Pod Startup Latency Measurements -{{$j}}
    measurements:
    - Identifier: PodStartupLatency
      Method: PodStartupLatency
      Params:
        action: start
        labelSelector: group={{$groupName}}-{{$j}}
        threshold: {{$podStartupLatencyThreshold}}
  - name: Starting Deployment Latency Measurements -{{$j}}
    measurements:
    - Identifier: WaitForControlledPodsRunning
      Method: WaitForControlledPodsRunning
      Params:
        action: start
        apiVersion: apps/v1
        kind: Deployment
        labelSelector: group={{$groupName}}-{{$j}}
        operationTimeout: {{$operationTimeout}}
  - name: Create Deployments {{$j}}
    phases:
      - namespaceRange:
          min: 1
          max: 1
        replicasPerNamespace: 1
        tuningSet: DeploymentCreateQps
        objectBundle:
          - basename: deployment-churn-{{$j}}
            objectTemplatePath: swiftv2_deployment_template.yaml
            templateFillMap:
              Replicas: {{$nodesPerStep}}
              Group: {{$groupName}}-{{$j}}
              CpuRequest: {{$latencyPodCpu}}m
              MemoryRequest: {{$latencyPodMemory}}M
              deploymentLabel: start
              pniName: pod-network-instance-dynamic-0-{{$j}}
  - name: Wait for all Deployments to be Running -{{$j}}
    measurements:
    - Identifier: WaitForControlledPodsRunning
      Method: WaitForControlledPodsRunning
      Params:
        action: gather
        apiVersion: apps/v1
        kind: Deployment
        labelSelector: group={{$groupName}}-{{$j}}
        operationTimeout: {{$operationTimeout}}
  - name: Starting measurement Pod Curl Command -{{$j}}
    measurements:
    - Identifier: PodPeriodicCommand
      Method: PodPeriodicCommand
      Params:
        action: start
        labelSelector: group={{$groupName}}-{{$j}}
        interval: 300s
        container: deployment-churn
        limit: {{$nodesPerStep}} 
        failOnCommandError: true
        failOnExecError: true
        failOnTimeout: true
        commands:
        - name: CustPodCurl
          # 172.27.0.30 is the IP of the service created in swiftv2kubeobjects/nginx-deployment.yaml
          command: ["/bin/sh", "-c", "curl --retry 3 --retry-delay 10 --max-time 15 172.27.0.30"]
          timeout: 30s
  - name: Wait for curl command to be done -{{$j}}
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 15m
  - name: Ending measurement Pod Curl Command -{{$j}}
    measurements:
    - Identifier: PodPeriodicCommand
      Method: PodPeriodicCommand
      Params:
        action: gather
        labelSelector: group={{$groupName}}-{{$j}}
  - name: Gather Pod Startup Latency Measurements -{{$j}}
    measurements:
    - Identifier: PodStartupLatency
      Method: PodStartupLatency
      Params:
        action: gather
        labelSelector: group={{$groupName}}-{{$j}}
  {{end}}