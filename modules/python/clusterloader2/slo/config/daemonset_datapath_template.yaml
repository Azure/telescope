
# {{$HostNetworkMode := DefaultParam .CL2_USE_HOST_NETWORK_PODS false}}
# {{$Image := DefaultParam .Image "registry.k8s.io/pause:3.9"}}
# {{$Env := DefaultParam .Env ""}}
# {{$DaemonSetSurge := DefaultParam .CL2_DS_SURGE (MaxInt 10 (DivideInt .Nodes 20))}} # 5% of nodes, but not less than 10
# {{$RUN_ON_ARM_NODES := DefaultParam .CL2_RUN_ON_ARM_NODES false}}

# {{$ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST := DefaultParam .CL2_ENABLE_NETWORK_POLICY_ENFORCEMENT_LATENCY_TEST false}}
# {{$NET_POLICY_ENFORCEMENT_LATENCY_NODE_LABEL_VALUE := DefaultParam .CL2_NET_POLICY_ENFORCEMENT_LATENCY_NODE_LABEL_VALUE "net-policy-client"}}

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{.Name}}
  namespace: slo-1
  labels:
    group: {{.Group}}
    kubernetes.azure.com/pod-network: pn100
    kubernetes.azure.com/pod-network-instance: pod-network-instance-0
spec:
  updateStrategy:
    type: OnDelete
  selector:
    matchLabels:
      name: {{.Name}}
  template:
    metadata:
      labels:
        group: {{.Group}}
        name: {{.Name}}
        kubernetes.azure.com/pod-network: pn100
        kubernetes.azure.com/pod-network-instance: pod-network-instance-0
    spec:
      hostNetwork: false #{{$HostNetworkMode}}
      # initContainers:
      # - name: connectivity-check
      #   image: busybox
      #   command: ["/bin/sh", "-c"]
      #   args: ["ping -c 3 172.25.0.11 && exit 0 || exit 1"] # Replace <target_endpoint>
      #   # Add other configurations for the init container if needed    
      containers:
      - name: daemonset
        image: "mcr.microsoft.com/azurelinux/base/nginx:1.25" #{{$Image}}
        env:
          - name: TEST_ENV
            value: "" # {{$Env}}
        resources:
          # Keep the CpuRequest/MemoryRequest request equal percentage of 1-core, 4GB node.
          # For now we're setting it to 0.5%.
          requests:
            cpu: 5m
            memory: "20M"
      terminationGracePeriodSeconds: 1
      nodeSelector:   
        slo: "true"
      tolerations:
      - key: "slo"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      - key: "DeletionCandidateOfClusterAutoscaler"
        operator: "Exists"
        effect: "PreferNoSchedule"
      - effect: NoExecute
        key: node.kubernetes.io/not-ready
        operator: Exists
        tolerationSeconds: 300
      - effect: NoExecute
        key: node.kubernetes.io/unreachable
        operator: Exists
        tolerationSeconds: 300