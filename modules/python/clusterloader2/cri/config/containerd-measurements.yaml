{{$action := .action}} # start, gather

steps:
  - name: {{$action}} Containerd Measurements
    measurements:
    - Identifier: ContainerdCriImagePullingThroughput
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: ContainerdCriImagePullingThroughput
        metricVersion: v1
        unit: MB/s
        queries:
        # Weighted average throughput per image pull (nodes with more pulls have more weight)
        - name: Avg
          query: sum(rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum(rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))
        # Unweighted average - each node contributes equally regardless of pull count (filtered for active nodes)
        - name: AvgPerNode
          query: avg((sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))
        # Number of successful image pull observations
        - name: Count
          query: sum(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"})
        # Cluster level percentiles - throughput distribution across nodes (filtered to exclude nodes with no pulls)
        - name: Perc50
          query: quantile(0.5, (sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))
        - name: Perc90
          query: quantile(0.9, (sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))
        - name: Perc99
          query: quantile(0.99, (sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))

        # ===== DEBUG METRICS =====
        # Total data transferred (sum of all image sizes pulled, in MB)
        - name: Debug_TotalDataMB
          query: sum(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"})
        # Number of nodes actively pulling images
        - name: Debug_ActiveNodes
          query: count(sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0)
        # Min throughput across nodes (identify slowest node)
        - name: Debug_MinNodeThroughput
          query: min((sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))
        # Max throughput across nodes (identify fastest node)
        - name: Debug_MaxNodeThroughput
          query: max((sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))
        # Spread (max - min) to see variance across nodes
        - name: Debug_ThroughputSpread
          query: max((sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0)) - min((sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))
        # Standard deviation of per-node throughput
        - name: Debug_ThroughputStdDev
          query: stddev((sum by (instance) (rate(containerd_cri_image_pulling_throughput_sum{nodepool=~"userpool.*"}[%v])) / sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))) and (sum by (instance) (rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v])) > 0))
        # Rate of image pulls (pulls per second across cluster)
        - name: Debug_PullRatePerSec
          query: sum(rate(containerd_cri_image_pulling_throughput_count{nodepool=~"userpool.*"}[%v]))
