{{$action := .action}}
{{$registryEndpoint := DefaultParam .RegistryEndpoint "acrtelescope.azurecr.io"}}
{{$testImage := DefaultParam .TestImage "benchmark/payload-1gb:v0"}}

# Network diagnostic job to measure raw download throughput (no containerd overhead)
# This runs curl directly to measure ACR â†’ Node network speed

{{if eq $action "start"}}
steps:
  - name: Create network diagnostic job
    phases:
    - namespaceRange:
        min: 1
        max: 1
      replicasPerNamespace: 1
      tuningSet: Uniform1qps
      objectBundle:
      - basename: network-diagnostic
        objectTemplatePath: network-diagnostic-job.yaml
        templateFillMap:
          RegistryEndpoint: {{$registryEndpoint}}
          TestImage: {{$testImage}}

  - name: Wait for network diagnostic to complete
    measurements:
      - Identifier: WaitForNetworkDiagnostic
        Method: WaitForControlledPodsRunning
        Params:
          action: start
          checkIfPodsAreUpdated: true
          apiVersion: batch/v1
          kind: Job
          labelSelector: app = network-diagnostic
          operationTimeout: 10m
{{end}}

{{if eq $action "gather"}}
steps:
  - name: Collect network diagnostic logs
    measurements:
      - Identifier: NetworkDiagnosticLogs
        Method: Exec
        Params:
          action: gather
          command:
            - /bin/sh
            - -c
            - |
              kubectl logs -l app=network-diagnostic --all-containers=true -n resource-consumer-1 2>/dev/null || echo "No logs available"
{{end}}
