{{$action := .action}} # start, gather

steps:
  - name: {{$action}} Node Resource Measurements
    measurements:
    - Identifier: ResourceMetrics
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Resource Metrics Summary
        metricVersion: v1
        unit: mixed
        queries:
        # Node Level Summary
        - name: TotalNodes
          query: count(kube_node_status_allocatable{resource="cpu"})
        - name: NodeCPUAllocatable
          query: sum(kube_node_status_allocatable{resource="cpu"})
        - name: NodeMemoryAllocatable
          query: sum(kube_node_status_allocatable{resource="memory"})
        # Node CPU Usage Stats (from kubelet/cAdvisor - container metrics aggregated by node)
        - name: NodeCPUUsageAvg
          query: avg(sum by (instance) (rate(container_cpu_usage_seconds_total{id="/"}[2m])))
        - name: NodeCPUUsageMax
          query: max(sum by (instance) (rate(container_cpu_usage_seconds_total{id="/"}[2m])))
        - name: NodeCPUUsageMin
          query: min(sum by (instance) (rate(container_cpu_usage_seconds_total{id="/"}[2m])))
        # Node Memory Usage Stats (from kubelet/cAdvisor - container metrics aggregated by node)
        - name: NodeMemoryUsageAvg
          query: avg(sum by (instance) (container_memory_working_set_bytes{id="/"}))
        - name: NodeMemoryUsageMax
          query: max(sum by (instance) (container_memory_working_set_bytes{id="/"}))
        - name: NodeMemoryUsageMin
          query: min(sum by (instance) (container_memory_working_set_bytes{id="/"}))
        # Pod Level Summary
        - name: TotalPods
          query: count(kube_pod_status_phase{phase="Running"})
        # Pod Distribution Summary
        - name: PodsPerNodeAvg
          query: avg(count by (node) (kube_pod_info{node!=""}))
        - name: PodsPerNodeMax
          query: max(count by (node) (kube_pod_info{node!=""}))
        - name: PodsPerNodeMin
          query: min(count by (node) (kube_pod_info{node!=""}))