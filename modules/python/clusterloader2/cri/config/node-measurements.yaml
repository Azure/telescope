{{$action := .action}} # start, gather
{{$node := .node}}

steps:
  - name: {{$action}} Node Resource Measurements
    measurements:
    - Identifier: ResourceMetrics
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: NodeResourceMetrics
        metricVersion: v1
        unit: mixed
        queries:
        # Node Level Summary
        - name: NodeInfo
          query: count(kube_node_info{node = "{{$node}}"})
        - name: TotalNodes
          query: count(kube_node_status_allocatable{resource="cpu", node = "{{$node}}"})
        - name: NodeCPUAllocatable
          query: sum(kube_node_status_allocatable{resource="cpu", node = "{{$node}}"})
        - name: NodeMemoryAllocatableGiB
          query: sum(kube_node_status_allocatable{resource="memory", node = "{{$node}}"}) / 1073741824
        - name: NodeMemoryCapacityGiB
          query: sum(kube_node_status_capacity{resource="memory", node = "{{$node}}"}) / 1073741824
        - name: NodesReady
          query: count(kube_node_status_condition{condition="Ready",status="true", node = "{{$node}}"})
        - name: NodePressureStatus
          query: kube_node_status_condition{condition="MemoryPressure", status="true", node = "{{$node}}"}
        # Node CPU Usage Stats (from kubelet/cAdvisor - container metrics aggregated by node)
        - name: NodeCPUUsageAvg
          query: avg(sum by (instance) (rate(container_cpu_usage_seconds_total{id="/"}[2m])))
        - name: NodeCPUUsageMax
          query: max(sum by (instance) (rate(container_cpu_usage_seconds_total{id="/"}[2m])))
        - name: NodeCPUUsageMin
          query: min(sum by (instance) (rate(container_cpu_usage_seconds_total{id="/"}[2m])))
        - name: NodeCPURequestsTotal
          query: sum(kube_pod_container_resource_requests{resource="cpu", node = "{{$node}}"})
        # Node Memory Usage Stats (from kubelet/cAdvisor - container metrics aggregated by node)
        - name: NodeMemoryUsageMaxGiB
          query: max(sum by (instance) (container_memory_working_set_bytes{id="/"})) / 1073741824
        - name: NodeMemoryRequestsTotalGiB
          query: sum(kube_pod_container_resource_requests{resource="memory", node = "{{$node}}"}) / 1073741824
        - name: NodeMemoryCommitmentGiB
          query: (sum(kube_pod_container_resource_limits{resource="memory", node = "{{$node}}"}) - sum(kube_node_status_allocatable{resource="memory", node = "{{$node}}"})) / 1073741824
        # Pod Level Summary
        - name: TotalPods
          query: count(kube_pod_status_phase{phase="Running"} * on(node) group_left kube_node_info{node = "{{$node}}"})
        # Pod Distribution Summary
        - name: PodMemoryRequestToAllocatableRatio
          query: sum(kube_pod_container_resource_requests{resource="memory", node = "{{$node}}"}) / sum(kube_node_status_allocatable{resource="memory", node = "{{$node}}"})
        - name: PodMemoryUsageToAllocatableRatio
          query: sum(container_memory_working_set_bytes{node = "{{$node}}"}) / sum(kube_node_status_allocatable{resource="memory", node = "{{$node}}"})
        - name: PodMemoryUsageToLimitsRatio
          query: sum(container_memory_working_set_bytes{node = "{{$node}}"}) / sum(kube_pod_container_resource_limits{resource="memory", node = "{{$node}}"})
        # Container Level Summary
        - name: ContainerRuntimes
          query: count by (container_runtime_version) (kube_node_info{node = "{{$node}}"})
        - name: ContainerMemoryFailures
          query: sum(increase(container_memory_failcnt{node = "{{$node}}"}[5m]))
        - name: ContainersNearMemoryLimit
          query: count((container_memory_working_set_bytes{node = "{{$node}}"} / container_spec_memory_limit_bytes{node = "{{$node}}"} > 0.8))