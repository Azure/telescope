{{$action := .action}} # start, gather

steps:
  - name: {{$action}} Kubelet Measurements
    measurements:
    - Identifier: KubeletPodStartupSLIDuration
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: KubeletPodStartupSLIDuration
        metricVersion: v1
        unit: s
        dimensions:
          - node
        queries:
        - name: Perc100
          query: histogram_quantile(1, kubelet_pod_start_sli_duration_seconds_bucket)
        - name: Perc99
          query: histogram_quantile(0.99, kubelet_pod_start_sli_duration_seconds_bucket)
          threshold: 5.0
        - name: Perc90
          query: histogram_quantile(0.9, kubelet_pod_start_sli_duration_seconds_bucket)
        - name: Perc50
          query: histogram_quantile(0.5, kubelet_pod_start_sli_duration_seconds_bucket)
        - name: Sum
          query: kubelet_pod_start_sli_duration_seconds_sum
        - name: Count
          query: kubelet_pod_start_sli_duration_seconds_count
  - name: {{$action}} Containerd Measurements
    measurements:
    - Identifier: ContainerdCriSandboxCreateNetwork
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: ContainerdCriSandboxCreateNetwork
        metricVersion: v1
        unit: s
        dimensions:
          - node
        queries:
        - name: Perc100
          query: histogram_quantile(1, containerd_cri_sandbox_create_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc99
          query: histogram_quantile(0.99, containerd_cri_sandbox_create_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc90
          query: histogram_quantile(0.9, containerd_cri_sandbox_create_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc50
          query: histogram_quantile(0.5, containerd_cri_sandbox_create_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Sum
          query: containerd_cri_sandbox_create_network_seconds_sum{nodepool=~"userpool.*"}
        - name: Count
          query: containerd_cri_sandbox_create_network_seconds_count{nodepool=~"userpool.*"}
    - Identifier: ContainerdCriSandboxDeleteNetwork
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: ContainerdCriSandboxDeleteNetwork
        metricVersion: v1
        unit: s
        dimensions:
          - node
        queries:
        - name: Perc100
          query: histogram_quantile(1, containerd_cri_sandbox_delete_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc99
          query: histogram_quantile(0.99, containerd_cri_sandbox_delete_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc90
          query: histogram_quantile(0.9, containerd_cri_sandbox_delete_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc50
          query: histogram_quantile(0.5, containerd_cri_sandbox_delete_network_seconds_bucket{nodepool=~"userpool.*"})
        - name: Sum
          query: containerd_cri_sandbox_delete_network_seconds_sum{nodepool=~"userpool.*"}
        - name: Count
          query: containerd_cri_sandbox_delete_network_seconds_count{nodepool=~"userpool.*"}
    - Identifier: ContainerdCriNetworkPluginOperations
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: ContainerdCriNetworkPluginOperations
        metricVersion: v1
        unit: s
        dimensions:
          - node
          - operation_type
        queries:
        - name: Perc100
          query: histogram_quantile(1, containerd_cri_network_plugin_operations_duration_seconds_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc99
          query: histogram_quantile(0.99, containerd_cri_network_plugin_operations_duration_seconds_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc90
          query: histogram_quantile(0.9, containerd_cri_network_plugin_operations_duration_seconds_seconds_bucket{nodepool=~"userpool.*"})
        - name: Perc50
          query: histogram_quantile(0.5, containerd_cri_network_plugin_operations_duration_seconds_seconds_bucket{nodepool=~"userpool.*"})
        - name: Sum
          query: containerd_cri_network_plugin_operations_duration_seconds_seconds_sum{nodepool=~"userpool.*"}
        - name: Count
          query: containerd_cri_network_plugin_operations_duration_seconds_seconds_count{nodepool=~"userpool.*"}
