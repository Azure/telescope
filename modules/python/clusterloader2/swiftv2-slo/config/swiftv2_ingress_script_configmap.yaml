apiVersion: v1
kind: ConfigMap
metadata:
  name: swiftv2-ingress-script
  namespace: {{.Namespace}}
data:
  ingress-egress-check.sh: |
    #!/bin/bash
    set -u

    LOGFILE="${LOGFILE_PATH:-/var/log/swiftv2/ingress-test.log}"
    mkdir -p "$(dirname "${LOGFILE}")"
    exec > >(tee -a "${LOGFILE}") 2>&1
    set -o pipefail

    log() {
      echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] $*"
    }

    MAX_ATTEMPTS="${INGRESS_MAX_ATTEMPTS:-3}"
    RETRY_DELAY="${INGRESS_RETRY_SECONDS:-10}"
    SERVICE_IP="${INGRESS_SERVICE_IP:-172.27.0.30}"
    MY_INDEX="${POD_INDEX:-0}"
    MY_STEP="${STEP_NUM:-0}"
    TOTAL_PODS="${TOTAL_PODS_PER_STEP:-1}"
    NAMESPACE="${NAMESPACE:-default}"
    PING_COUNT="${PING_COUNT:-3}"
    PING_TIMEOUT="${PING_TIMEOUT:-5}"
    TARGET_READY_TIMEOUT="${TARGET_READY_TIMEOUT:-120s}"

    run_custpodcurl() {
      log "CustPodCurl: curling ${SERVICE_IP}"
      curl --fail --retry 5 --retry-delay 3 --max-time 60 "${SERVICE_IP}" >/dev/null
    }

    run_ingress_ping() {
      log "IngressConnectivity: looking for any ready pod in step ${MY_STEP}"
      
      # Only skip peer test if we explicitly know we're in single-pod deployment
      if [ "${TOTAL_PODS}" -eq 1 ]; then
        log "IngressConnectivity: TOTAL_PODS=1, skipping peer connectivity test (expected single pod)"
        return 0
      fi
      
      # Get all pods in this step except myself
      local all_pods
      all_pods=$(kubectl get pods -n "${NAMESPACE}" -l "step=${MY_STEP}" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)
      if [ -z "${all_pods}" ]; then
        log "IngressConnectivity: ERROR - no pods found in step ${MY_STEP} (expected ${TOTAL_PODS} pods)"
        return 1
      fi

      local peer_count=0
      # Try each pod until we find one with an IP
      for target_pod in ${all_pods}; do
        # Skip myself
        if [[ "${target_pod}" == *"-${MY_INDEX}-"* ]] || [[ "${target_pod}" == *"-${MY_INDEX}" ]]; then
          continue
        fi
        
        peer_count=$((peer_count + 1))

        log "IngressConnectivity: checking pod ${target_pod}"
        local target_ip
        target_ip=$(kubectl get mtpnc "${target_pod}" -n "${NAMESPACE}" -o jsonpath='{.status.primaryIP}' 2>/dev/null | cut -d'/' -f1 | tr -d '\n')
        
        if [ -n "${target_ip}" ]; then
          log "IngressConnectivity: found target ${target_pod} with IP ${target_ip}, attempting ping"
          if ping -c "${PING_COUNT}" -W "${PING_TIMEOUT}" "${target_ip}" >/dev/null 2>&1; then
            log "IngressConnectivity: SUCCESS - pinged ${target_pod} at ${target_ip}"
            return 0
          else
            log "IngressConnectivity: ping to ${target_pod} at ${target_ip} failed, trying next pod"
          fi
        fi
      done

      log "IngressConnectivity: ERROR - found 0 peer pods (expected ~${TOTAL_PODS} total pods). This indicates a configuration or discovery issue."
      return 1
    }

    attempt=1
    while [ "${attempt}" -le "${MAX_ATTEMPTS}" ]; do
      log "Attempt ${attempt}/${MAX_ATTEMPTS} starting"

      if run_custpodcurl && run_ingress_ping; then
        log "Ingress/Egress validation succeeded"
        touch /tmp/ingress-test-passed
        exit 0
      fi

      log "Attempt ${attempt} failed"
      attempt=$((attempt + 1))
      if [ "${attempt}" -le "${MAX_ATTEMPTS}" ]; then
        log "Retrying after ${RETRY_DELAY}s"
        sleep "${RETRY_DELAY}"
      fi
    done

    log "All attempts failed - marking test as failed"
    touch /tmp/ingress-test-failed
    exit 0
