name: deployment-churn

{{$podsPerNode := DefaultParam .CL2_PODS_PER_NODE 1}}
{{$podsPerStep := DefaultParam .CL2_PODS_PER_STEP 7}}
{{$nodes := DefaultParam .CL2_NODES 1000}}
{{$total_pods := DefaultParam .CL2_TOTAL_PODS 7000}}
{{$steps := DefaultParam .CL2_STEPS 1}}
{{$latencyPodCpu := DefaultParam .CL2_LATENCY_POD_CPU 10}}
{{$latencyPodMemory := DefaultParam .CL2_LATENCY_POD_MEMORY 50}}
{{$podStartupLatencyThreshold := DefaultParam .CL2_POD_STARTUP_LATENCY_THRESHOLD "60s"}}
{{$operationTimeout := DefaultParam .CL2_OPERATION_TIMEOUT "120s"}}
{{$groupName := DefaultParam .CL2_GROUP_NAME "deployment-churn"}}

namespace:
  number: 1
  prefix: slo
  deleteStaleNamespaces: false
  deleteAutomanagedNamespaces: false
  enableExistingNamespaces: false

tuningSets:
  - name: DeploymentCreatePNIQps
    qpsLoad:
      qps: 1
  - name: DeploymentCreateQps
    qpsLoad:
      qps: 1

steps:
  - name: Log - steps={{$steps}}, nodes={{$nodes}}, pods/step={{$podsPerStep}}, pods/node={{$podsPerNode}}, total pods={{$total_pods}}
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 1ms
  - name: "Create RBAC Resources"
    phases:
    - namespaceRange:
        min: 1
        max: 1
      replicasPerNamespace: 1
      tuningSet: DeploymentCreatePNIQps
      objectBundle:
      - basename: swiftv2-sa
        objectTemplatePath: serviceaccount_template.yaml
        templateFillMap:
          Namespace: slo-1
      - basename: swiftv2-role
        objectTemplatePath: role_template.yaml
        templateFillMap:
          Namespace: slo-1
      - basename: swiftv2-binding
        objectTemplatePath: rolebinding_template.yaml
        templateFillMap:
          Namespace: slo-1
  - name: "Create PNI"
    phases:
    - namespaceRange:
        min: 1
        max: 1
      replicasPerNamespace: 1
      tuningSet: DeploymentCreatePNIQps
      objectBundle:
      - basename: pod-network-instance
        objectTemplatePath: pni_dynamic_template.yaml
  - name: Wait for PNI to be created and nodes to be registered
    measurements:
      - Identifier: Dummy
        Method: Sleep
        Params:
          duration: 60s
  - name: Starting Pod Startup Latency Measurements
    measurements:
    - Identifier: PodStartupLatency
      Method: PodStartupLatency
      Params:
        action: start
        labelSelector: podgroup={{$groupName}}
        threshold: {{$podStartupLatencyThreshold}}
  {{range $j := Loop $steps}}
  - name: Starting Deployment Latency Measurements -{{$j}}
    measurements:
    - Identifier: WaitForControlledPodsRunning-{{$j}}
      Method: WaitForControlledPodsRunning
      Params:
        action: start
        apiVersion: apps/v1
        kind: Deployment
        labelSelector: group={{$groupName}}-{{$j}}
        operationTimeout: {{$operationTimeout}}
  - name: Create Deployments {{$j}}
    phases:
      - namespaceRange:
          min: 1
          max: 1
        replicasPerNamespace: 1
        tuningSet: DeploymentCreateQps
        objectBundle:
          - basename: deployment-churn-{{$j}}
            objectTemplatePath: swiftv2_deployment_template.yaml
            templateFillMap:
              Replicas: {{$podsPerStep}}
              PodGroup: {{$groupName}}
              Group: {{$groupName}}-{{$j}}
              CpuRequest: {{$latencyPodCpu}}m
              MemoryRequest: {{$latencyPodMemory}}M
              deploymentLabel: start
              pniName: pod-network-instance-0
              Location: {{$.CL2_LOCATION}}
  - name: Wait for all Deployments to be Running -{{$j}}
    measurements:
    - Identifier: WaitForControlledPodsRunning-{{$j}}
      Method: WaitForControlledPodsRunning
      Params:
        action: gather
        apiVersion: apps/v1
        kind: Deployment
        labelSelector: group={{$groupName}}-{{$j}}
        operationTimeout: {{$operationTimeout}}
  - name: Wait for Pod Curl Commands to Start -{{$j}}
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        duration: 30s
  - name: Pod Curl Command for Deployment -{{$j}}
    measurements:
    - Identifier: PodPeriodicCommand-{{$j}}
      Method: PodPeriodicCommand
      Params:
        action: start
        labelSelector: group={{$groupName}}-{{$j}}
        interval: 60s
        container: deployment-churn
        limit: {{$podsPerStep}}
        failOnCommandError: true
        failOnExecError: true
        failOnTimeout: true
        commands:
        - name: CustPodCurl
          # 172.27.0.30 is the IP of the service created in swiftv2kubeobjects/nginx-deployment.yaml
          command: ["/bin/sh", "-c", "curl --retry 10 --retry-delay 3 --max-time 60 172.27.0.30"]
          timeout: 60s
        - name: IngressConnectivity
          command: 
          - "/bin/sh"
          - "-c"
          - |
            set -e
            MY_INDEX=${POD_INDEX}
            TARGET_INDEX=$((MY_INDEX + 1))
            NAMESPACE=${NAMESPACE:-"slo-1"}
            TOTAL_PODS={{$podsPerStep}}
            
            echo "Pod index ${MY_INDEX}: Looking for target pod with index ${TARGET_INDEX}"
            
            # Check if this is the last pod (no n+1 exists)
            if [ ${TARGET_INDEX} -ge ${TOTAL_PODS} ]; then
              echo "Pod ${MY_INDEX}: I am the last pod (${TOTAL_PODS} total), no n+1 to test. Exiting successfully."
              exit 0
            fi
            
            # Find target pod by label (pod-index set via Index template variable in deployment template)
            TARGET_POD=$(kubectl get pods -n ${NAMESPACE} -l "pod-index=${TARGET_INDEX}" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -z "$TARGET_POD" ]; then
              echo "Pod ${MY_INDEX}: No target pod found with index ${TARGET_INDEX} (might be last pod)"
              exit 0
            fi
            echo "Pod ${MY_INDEX}: Found target pod: ${TARGET_POD}"
            
            # MTPNC name == pod name (1:1 mapping)
            MTPNC_NAME=${TARGET_POD}
            TARGET_IP=$(kubectl get mtpnc ${MTPNC_NAME} -n ${NAMESPACE} -o jsonpath='{.status.allocatedIPs[0]}' 2>/dev/null || echo "")
            if [ -z "$TARGET_IP" ]; then
              echo "ERROR: Pod ${MY_INDEX}: Could not get Swift v2 IP from MTPNC ${MTPNC_NAME}"
              exit 1
            fi
            echo "Pod ${MY_INDEX}: Testing ingress to Pod ${TARGET_INDEX} (${TARGET_POD}) at ${TARGET_IP}"
            
            # Test Swift v2 IP connectivity
            if curl --connect-timeout 10 --max-time 30 http://${TARGET_IP}:80 2>&1 | head -5; then
              echo "SUCCESS: Pod ${MY_INDEX} -> Pod ${TARGET_INDEX} (${TARGET_IP})"
              exit 0
            else
              echo "FAILURE: Pod ${MY_INDEX} -> Pod ${TARGET_INDEX} (${TARGET_IP})"
              exit 1
            fi
          timeout: 60s
  - name: Wait for Pod Curl Commands to Execute -{{$j}}
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        duration: 60s
  - name: Gather Pod Curl Command Results -{{$j}}
    measurements:
    - Identifier: PodPeriodicCommand-{{$j}}
      Method: PodPeriodicCommand
      Params:
        action: gather
        labelSelector: group={{$groupName}}-{{$j}}
  {{end}}
  - name: Gather Pod Startup Latency Measurements
    measurements:
    - Identifier: PodStartupLatency
      Method: PodStartupLatency
      Params:
        action: gather
        labelSelector: podgroup={{$groupName}}