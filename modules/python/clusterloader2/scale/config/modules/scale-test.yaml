name: scale-test

# generic config
{{$groupName := DefaultParam .CL2_GROUP_NAME "scale-test"}}
{{$operationTimeout := DefaultParam .CL2_OPERATION_TIMEOUT "5m"}}
{{$apiServerCallsPerSecond := DefaultParam .CL2_API_SERVER_CALLS_PER_SECOND 100}}

# topology config
{{$namespaces := DefaultParam .CL2_NAMESPACES 1}}
{{$deploymentsPerNamespace := DefaultParam .CL2_DEPLOYMENTS_PER_NAMESPACE 10}}
{{$replicasPerNamespace := DefaultParam .CL2_REPLICAS_PER_NAMESPACE 5}}

# topology config
{{$fortioServerReplicas := DefaultParam .CL2_FORTIO_SERVERS_PER_DEPLOYMENT 10}}
{{$fortioClientReplicas := DefaultParam .CL2_FORTIO_CLIENTS_PER_DEPLOYMENT 10}}
{{$fortioClientQueriesPerSecond := DefaultParam .CL2_FORTIO_CLIENT_QUERIES_PER_SECOND 1000}}
{{$fortioClientConnections := DefaultParam .CL2_FORTIO_CLIENT_CONNECTIONS 10}}
{{$fortioNamespaces := DefaultParam .CL2_FORTIO_NAMESPACES 1}}
{{$fortioDeploymentsPerNamespace := DefaultParam .CL2_FORTIO_DEPLOYMENTS_PER_NAMESPACE 1}}

# Network Policies
{{$networkPoliciesPerNamespace := DefaultParam .CL2_NETWORK_POLICIES_PER_NAMESPACE 0}}

# Retina Network Flow Log config
{{$createRetinaNetworkFlowLogs := DefaultParam .createRetinaNetworkFlowLogs false}}

# PFL
{{$suffix := ""}}
{{if $createRetinaNetworkFlowLogs}}
{{$suffix = "WithRetinaNetworkFlowLogs"}}
{{end}}

steps:
  - module:
      path: /modules/measurements.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/retina-measurements.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/cilium-measurements.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/ama-logs-measurements.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/node-disk-measurements.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  # deployment creation
  # - module:
  #     path: /modules/kapinger.yaml
  #     params:
  #       namespaces: {{$namespaces}}
  #       tuningSet: DeploymentCreateQps
  #       deployments: {{$deploymentsPerNamespace}}
  #       podReplicas: {{$replicasPerNamespace}}
  #

  - module:
      path: /modules/reconcile-objects.yaml
      params:
        actionName: "create"
        tuningSet: DeploymentCreateQps
        operationTimeout: {{$operationTimeout}}
        Group: {{$groupName}}
        namespaces: {{$fortioNamespaces}}
        fortioDeploymentsPerNamespace: {{$fortioDeploymentsPerNamespace}}
        fortioServerReplicas: {{$fortioServerReplicas}}
        fortioClientReplicas: {{$fortioClientReplicas}}
        fortioClientQueriesPerSecond: {{$fortioClientQueriesPerSecond}}
        fortioClientConnections: {{$fortioClientConnections}}
        generateRetinaNetworkFlowLogs: {{$createRetinaNetworkFlowLogs}}
        deploymentLabel: start
        networkPoliciesPerNamespace: {{$networkPoliciesPerNamespace}}

  # FIXME: is this needed?
  - module:
      path: /modules/measurements.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/retina-measurements.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/cilium-measurements.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/ama-logs-measurements.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/node-disk-measurements.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"
