name: scale-test

# generic config
{{$groupName := DefaultParam .CL2_GROUP_NAME "scale-test"}}
{{$operationTimeout := DefaultParam .CL2_OPERATION_TIMEOUT "15m"}}

# topology config
{{$namespaces := DefaultParam .CL2_NAMESPACES 1}}
{{$deploymentsPerNamespace := DefaultParam .CL2_DEPLOYMENTS_PER_NAMESPACE 10}}
{{$replicasPerNamespace := DefaultParam .CL2_REPLICAS_PER_NAMESPACE 5}}

# topology config
{{$fortioServerReplicas := DefaultParam .CL2_FORTIO_SERVERS_PER_DEPLOYMENT 10}}
{{$fortioClientReplicas := DefaultParam .CL2_FORTIO_CLIENTS_PER_DEPLOYMENT 10}}
{{$fortioClientQueriesPerSecond := DefaultParam .CL2_FORTIO_CLIENT_QUERIES_PER_SECOND 1000}}
{{$fortioClientConnections := DefaultParam .CL2_FORTIO_CLIENT_CONNECTIONS 10}}
{{$fortioNamespaces := DefaultParam .CL2_FORTIO_NAMESPACES 1}}
{{$fortioDeploymentsPerNamespace := DefaultParam .CL2_FORTIO_DEPLOYMENTS_PER_NAMESPACE 1}}

# Network Policies
{{$networkPoliciesPerNamespace := DefaultParam .CL2_NETWORK_POLICIES_PER_NAMESPACE 0}}

# Retina Network Flow Log config
{{$createRetinaNetworkFlowLogs := DefaultParam .createRetinaNetworkFlowLogs false}}

# PFL
{{$suffix := ""}}
{{if $createRetinaNetworkFlowLogs}}
{{$suffix = "WithRetinaNetworkFlowLogs"}}
{{end}}

steps:
  - module:
      path: /modules/measurements/control-plane.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/retina.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/cilium.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/ama-logs.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/node-disk.yaml
      params:
        action: start
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/test-steps.yaml
      params:
        tuningSet: DeploymentCreateQps
        operationTimeout: {{$operationTimeout}}
        Group: {{$groupName}}
        namespaces: {{$fortioNamespaces}}
        fortioDeploymentsPerNamespace: {{$fortioDeploymentsPerNamespace}}
        fortioServerReplicas: {{$fortioServerReplicas}}
        fortioClientReplicas: {{$fortioClientReplicas}}
        fortioClientQueriesPerSecond: {{$fortioClientQueriesPerSecond}}
        fortioClientConnections: {{$fortioClientConnections}}
        generateRetinaNetworkFlowLogs: {{$createRetinaNetworkFlowLogs}}
        deploymentLabel: start
        networkPoliciesPerNamespace: {{$networkPoliciesPerNamespace}}
        labelTrafficPods: {{.labelTrafficPods}}

  - module:
      path: /modules/measurements/control-plane.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/retina.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/cilium.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/ama-logs.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"

  - module:
      path: /modules/measurements/node-disk.yaml
      params:
        action: gather
        group: {{$groupName}}
        suffix: "{{$suffix}}"
