## Kapinger module creates kapinger components

# Namespaces where kapinger will be deployed to
{{$namespaces := DefaultParam .namespaces 1}}
# Tuning set
{{$tuningSet := DefaultParam .tuningSet "DeploymentCreateQps"}}
# Number of deployments
{{$deployments := DefaultParam .deployments 10}}
# Number of pods per deployments
{{$podReplicas := DefaultParam .podReplicas 5}}

steps:
  - name: Start measurements
    measurements:
      - Identifier: WaitForControlledPodsRunning
        Method: WaitForControlledPodsRunning
        Params:
          action: start
          apiVersion: apps/v1
          kind: Deployment
          labelSelector: is-real = true
          operationTimeout: 120s
  - name: Create Kapinger Service Account
    phases:
      - namespaceRange:
          min: 1
          max: {{$namespaces}}
        replicasPerNamespace: 1
        tuningSet: {{$tuningSet}}
        objectBundle:
          - basename: kapinger-sa
            objectTemplatePath: "modules/kapinger/serviceaccount.yaml"
  - name: Create Kapinger Cluster Role
    phases:
      - namespaceList:
        - ""
        replicasPerNamespace: 1
        tuningSet: {{$tuningSet}}
        objectBundle:
          - basename: kapinger-role
            objectTemplatePath: "modules/kapinger/clusterrole.yaml"
  - name: Create Kapinger Cluster Role Binding
    phases:
      - namespaceList:
        - ""
        replicasPerNamespace: 1
        tuningSet: {{$tuningSet}}
        objectBundle:
          - basename: kapinger-rolebinding
            objectTemplatePath: "modules/kapinger/clusterrolebinding.yaml"
            templateFillMap:
              # TODO: allow multiple namespaces if kapinger will continue to be used
              subjectNamespace: scale-test-{{$namespaces}}
  - name: Create Kapinger Deployments
    phases:
      - namespaceRange:
          min: 1
          max: {{$namespaces}}
        replicasPerNamespace: {{$deployments}}
        tuningSet: {{$tuningSet}}
        objectBundle:
          - basename: kapinger
            objectTemplatePath: "modules/kapinger/deployment.yaml"
            templateFillMap:
              Replicas: {{$podReplicas}}
  - name: Create Kapinger Services
    phases:
      - namespaceRange:
          min: 1
          max: {{$namespaces}}
        replicasPerNamespace: {{$deployments}}
        tuningSet: {{$tuningSet}}
        objectBundle:
          - basename: kapinger-svc
            objectTemplatePath: "modules/kapinger/service.yaml"
  - name: Wait for pods to be running
    measurements:
      - Identifier: WaitForControlledPodsRunning
        Method: WaitForControlledPodsRunning
        Params:
          action: gather
  # TODO: Remove. Added just for testing
  - name: Log - deployments={{$deployments}}, podReplicas={{$podReplicas}}
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 120s
