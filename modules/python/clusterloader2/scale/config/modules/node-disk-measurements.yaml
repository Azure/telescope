{{$action := .action}} # start, gather

{{$suffix := DefaultParam .suffix ""}}

steps:
  - name: {{$action}} Additional Node Disk Measurements
    measurements:
    - Identifier: NodeDiskAvgWrittenBytes{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Node Disk Average Written Bytes {{$suffix}}
        metricVersion: v1
        unit: bytes
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(node_disk_written_bytes_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(node_disk_written_bytes_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(node_disk_written_bytes_total[1m])[%v:]))
    - Identifier: NodeDiskMaxWrittenBytes{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Node Disk Max Written Bytes {{$suffix}}
        metricVersion: v1
        unit: bytes
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(node_disk_written_bytes_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(node_disk_written_bytes_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(node_disk_written_bytes_total[1m])[%v:]))
    - Identifier: NodeDiskAvgWriteLatency{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Node Disk Average Write Latency {{$suffix}}
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time((rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]))[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time((rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]))[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time((rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]))[%v:]))
    - Identifier: NodeDiskMaxWriteLatency{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Node Disk Max Write Latency {{$suffix}}
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time((rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]))[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time((rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]))[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time((rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]))[%v:]))
