{{$action := .action}} # start, gather

{{$suffix := DefaultParam .suffix ""}}

steps:
  - name: {{$action}} Additional Cilium Measurements
    measurements:
    - Identifier: CiliumAvgCPUUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Average CPU Usage {{$suffix}}
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumMaxCPUUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Max CPU Usage {{$suffix}}
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(cilium_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumAvgMemUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Avg Memory Usage {{$suffix}}
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, avg_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumMaxMemUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Max Memory Usage {{$suffix}}
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, max_over_time(cilium_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumOperatorAvgCPUUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Avg CPU Usage {{$suffix}}
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumOperatorMaxCPUUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Max CPU Usage {{$suffix}}
        metricVersion: v1
        unit: cpu
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(cilium_operator_process_cpu_seconds_total[1m])[%v:]))
    - Identifier: CiliumOperatorMaxMemUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Max Memory Usage {{$suffix}}
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, max_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumOperatorAvgMemUsage{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Operator Avg Memory Usage {{$suffix}}
        metricVersion: v1
        unit: MB
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc90
          query: quantile(0.90, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
        - name: Perc50
          query: quantile(0.5, avg_over_time(cilium_operator_process_resident_memory_bytes[%v:]) / 1024 / 1024)
    - Identifier: CiliumContainerFsAvgWrittenBytes{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Container FS Average Written Bytes {{$suffix}}
        metricVersion: v1
        unit: bytes
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time(rate(container_fs_writes_bytes_total{container="cilium-agent"}[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time(rate(container_fs_writes_bytes_total{container="cilium-agent"}[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time(rate(container_fs_writes_bytes_total{container="cilium-agent"}[1m])[%v:]))
    - Identifier: CiliumContainerFsMaxWrittenBytes{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Container FS Max Written Bytes {{$suffix}}
        metricVersion: v1
        unit: bytes
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(rate(container_fs_writes_bytes_total{container="cilium-agent"}[1m])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(rate(container_fs_writes_bytes_total{container="cilium-agent"}[1m])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(rate(container_fs_writes_bytes_total{container="cilium-agent"}[1m])[%v:]))
    - Identifier: CiliumContainerFsAvgWriteLatency{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Container FS Average Write Latency {{$suffix}}
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, avg_over_time((rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]) / rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]))[%v:]))
        - name: Perc90
          query: quantile(0.90, avg_over_time((rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]) / rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]))[%v:]))
        - name: Perc50
          query: quantile(0.50, avg_over_time((rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]) / rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]))[%v:]))
    - Identifier: CiliumContainerFsMaxWriteLatency{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Container FS Max Write Latency {{$suffix}}
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time((rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]) / rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]))[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time((rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]) / rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]))[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time((rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]) / rate(container_fs_write_seconds_total{container="cilium-agent"}[1m]))[%v:]))
    - Identifier: CiliumContainerRestarts{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Container Restarts {{$suffix}}
        metricVersion: v1
        unit: s
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, max_over_time(increase(kube_pod_container_status_restarts_total{container="cilium-agent"}[%v])[%v:]))
        - name: Perc90
          query: quantile(0.90, max_over_time(increase(kube_pod_container_status_restarts_total{container="cilium-agent"}[%v])[%v:]))
        - name: Perc50
          query: quantile(0.50, max_over_time(increase(kube_pod_container_status_restarts_total{container="cilium-agent"}[%v])[%v:]))
    - Identifier: CiliumHubbleMetricsCardinality{{$suffix}}
      Method: GenericPrometheusQuery
      Params:
        action: {{$action}}
        metricName: Cilium Hubble Metrics Cardinality {{$suffix}}
        metricVersion: v1
        unit: "#"
        enableViolations: true
        queries:
        - name: Perc99
          query: quantile(0.99, count({__name__=~"hubble_.*"}) by (pod))
        - name: Perc90
          query: quantile(0.90, count({__name__=~"hubble_.*"}) by (pod))
        - name: Perc50
          query: quantile(0.50, count({__name__=~"hubble_.*"}) by (pod))
