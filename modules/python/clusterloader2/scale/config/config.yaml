name: scale-test

# generic config
{{$groupName := DefaultParam .CL2_GROUP_NAME "scale-test"}}
{{$operationTimeout := DefaultParam .CL2_OPERATION_TIMEOUT "5m"}}
{{$apiServerCallsPerSecond := DefaultParam .CL2_API_SERVER_CALLS_PER_SECOND 5}}

# topology config
{{$namespaces := DefaultParam .CL2_NAMESPACES 1}}
{{$deploymentsPerNamespace := DefaultParam .CL2_DEPLOYMENTS_PER_NAMESPACE 10}}
{{$replicasPerNamespace := DefaultParam .CL2_REPLICAS_PER_NAMESPACE 5}}

# topology config
{{$fortioServerReplicas := DefaultParam .CL2_FORTIO_SERVERS_PER_DEPLOYMENT 10}}
{{$fortioClientReplicas := DefaultParam .CL2_FORTIO_CLIENTS_PER_DEPLOYMENT 10}}
{{$fortioClientQueriesPerSecond := DefaultParam .CL2_FORTIO_CLIENT_QUERIES_PER_SECOND 1000}}
{{$fortioClientConnections := DefaultParam .CL2_FORTIO_CLIENT_CONNECTIONS 10}}
{{$fortioNamespaces := DefaultParam .CL2_FORTIO_NAMESPACES 1}}
{{$fortioDeploymentsPerNamespace := DefaultParam .CL2_FORTIO_DEPLOYMENTS_PER_NAMESPACE 1}}

# Retina Network Flow Log config
{{$generateRetinaNetworkFlowLogs := DefaultParam .CL2_GENERATE_RETINA_NETWORK_FLOW_LOGS false}}


namespace:
  number: {{$namespaces}}
  prefix: scale-test
  deleteStaleNamespaces: true
  deleteAutomanagedNamespaces: true
  enableExistingNamespaces: false

tuningSets:
  - name: Sequence
    parallelismLimitedLoad:
      parallelismLimit: 1
  - name: DeploymentCreateQps
    qpsLoad:
      qps: {{$apiServerCallsPerSecond}}
  # - name: DeploymentDeleteQps
  #   qpsLoad:
  #     qps: {{$apiServerCallsPerSecond}}

steps:
  - name: Log 
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 1ms

  - module:
      path: /modules/node-exporter.yaml
      params:
        actionName: "create"
        tuningSet: DeploymentCreateQps

  - module:
      path: /modules/kube-state-metrics.yaml
      params:
        actionName: "create"
        tuningSet: DeploymentCreateQps

  - name: Run Test without Creating Retina Network Flow Logs
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 1ms

  - module:
      path: /modules/scale-test.yaml
      params:
        action: start
        group: {{$groupName}}
        createRetinaNetworkFlowLogs: false

    {{if $generateRetinaNetworkFlowLogs}}
  - name: Wait 1m and run test Creating Retina Network Flow Logs
    measurements:
      - Identifier: Sleep
        Method: Sleep
        Params:
          duration: 1m

  - module:
      path: /modules/scale-test.yaml
      params:
        action: start
        group: {{$groupName}}
        createRetinaNetworkFlowLogs: true
    {{end}}
      
  - module:
      path: /modules/node-exporter.yaml
      params:
        actionName: "delete"
        tuningSet: DeploymentCreateQps

  - module:
      path: /modules/kube-state-metrics.yaml
      params:
        actionName: "delete"
        tuningSet: DeploymentCreateQps
