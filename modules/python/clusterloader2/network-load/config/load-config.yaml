name: load-config

# generic config
{{$groupName := DefaultParam .CL2_GROUP_NAME "network-load"}}
{{$operationTimeout := DefaultParam .CL2_OPERATION_TIMEOUT "15m"}}
{{$apiServerCallsPerSecond := DefaultParam .CL2_API_SERVER_CALLS_PER_SECOND 100}}

# repetition config
{{$deploymentRecreationCount := DefaultParam .CL2_DEPLOYMENT_RECREATION_COUNT 1}}

{{$roundsToCreateOrRecreate := AddInt 1 $deploymentRecreationCount}}

# scale logistics
{{$podStartupLatencyThreshold := DefaultParam .CL2_POD_STARTUP_LATENCY_THRESHOLD "3m"}}
##
##
###########################################
# Static variables 
{{$nodes := DefaultParam .CL2_NODES 1500}}
{{$fortioNamespaces := DefaultParam .CL2_FORTIO_NAMESPACES 35}}

{{$fortioServerDeployments := DefaultParam .CL2_FORTIO_SERVER_DEPLOYMENTS 350}}
{{$fortioClientDeployments := DefaultParam .CL2_FORTIO_CLIENT_DEPLOYMENTS 350}}

{{$fortioServerReplicasPerDeployment := DefaultParam .CL2_FORTIO_SERVER_REPLICAS_PER_DEPLOYMENT 150}}
{{$fortioClientReplicasPerDeployment := DefaultParam .CL2_FORTIO_CLIENT_REPLICAS_PER_DEPLOYMENT 150}}

{{$fortioClientQueriesPerSecond := DefaultParam .CL2_FORTIO_CLIENT_QUERIES_PER_SECOND 1000}}
###########################################
##
##
###########################################
# Dynamic variables based off above
{{$fortioServerDeploymentReplicasPerNamespace := DivideInt .CL2_FORTIO_SERVER_DEPLOYMENTS .CL2_FORTIO_NAMESPACES}}
{{$fortioClientDeploymentReplicasPerNamespace := DivideInt .CL2_FORTIO_CLIENT_DEPLOYMENTS .CL2_FORTIO_NAMESPACES}}

{{$fortioServiceReplicasPerNamespace := DivideInt .CL2_FORTIO_SERVER_DEPLOYMENTS .CL2_FORTIO_NAMESPACES}}

###########################################
##
##


# other test toggles
{{$applyFqdnCnp := DefaultParam .CL2_APPLY_FQDN_CNP true}}

# prometheus config
{{$ciliumMetricsEnabled := DefaultParam .CL2_CILIUM_METRICS_ENABLED false}}

namespace:
  number: {{$fortioNamespaces}}
  prefix: ns-telescope
  deleteAutomanagedNamespaces: false
  enableExistingNamespaces: true

tuningSets:
  - name: Sequence
    parallelismLimitedLoad:
      parallelismLimit: 1
  - name: DeploymentCreateQps
    qpsLoad:
      qps: {{$apiServerCallsPerSecond}}
  - name: DeploymentDeleteQps
    qpsLoad:
      qps: {{$apiServerCallsPerSecond}}

steps:
  - name: Log - fortioNamespaces={{$fortioNamespaces}}, fortioServerDeployments={{$fortioServerDeployments}}, fortioClientDeployments={{$fortioClientDeployments}}, fortioServerReplicasPerDeployment={{$fortioServerReplicasPerDeployment}}, fortioServiceReplicasPerNamespace=={{$fortioServiceReplicasPerNamespace}}
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 1ms

  - module:
      path: /modules/measurements.yaml
      params:
        action: start
        group: {{$groupName}}

{{if $ciliumMetricsEnabled}}
  - module:
      path: /modules/cilium-measurements.yaml
      params:
        action: start
{{end}}

# create resources that won't change
  - module:
      path: /modules/services.yaml
      params:
        actionName: "Creating"
        namespaces: {{$fortioNamespaces}}
        fortioServiceReplicasPerNamespace: {{$fortioServiceReplicasPerNamespace}}

  {{if $applyFqdnCnp}}
  - module:
      path: /modules/ciliumnetworkpolicy.yaml
      params:
        actionName: "Creating"
        namespaces: {{$fortioNamespaces}}
        Group: {{$groupName}}
        cnpsPerNamespace: 1
  {{end}}

# deployment creation
{{range $i := Loop $roundsToCreateOrRecreate}}
  - module:
      path: /modules/reconcile-objects.yaml
      params:
        actionName: "create"
        tuningSet: DeploymentCreateQps
        operationTimeout: {{$operationTimeout}}
        Group: {{$groupName}}
        namespaces: {{$fortioNamespaces}}
        fortioServerDeployments: {{$fortioServerDeployments}}
        fortioClientDeployments: {{$fortioClientDeployments}}
        fortioServerDeploymentReplicasPerNamespace: {{$fortioServerDeploymentReplicasPerNamespace}}
        fortioClientDeploymentReplicasPerNamespace: {{$fortioClientDeploymentReplicasPerNamespace}}
        fortioServerReplicasPerDeployment: {{$fortioServerReplicasPerDeployment}}
        fortioClientReplicasPerDeployment: {{$fortioClientReplicasPerDeployment}}
        fortioClientQueriesPerSecond: {{$fortioClientQueriesPerSecond}}
        deploymentLabel: start

# FIXME sleep intervals
  - name: Log - fortioNamespaces={{$fortioNamespaces}}, fortioServerDeployments={{$fortioServerDeployments}}, fortioClientDeployments={{$fortioClientDeployments}}, fortioServerReplicasPerDeployment={{$fortioServerReplicasPerDeployment}}
    measurements:
    - Identifier: Dummy
      Method: Sleep
      Params:
        action: start
        duration: 1m30s


{{end}}

{{if $ciliumMetricsEnabled}}
  - module:
      path: /modules/cilium-measurements.yaml
      params:
        action: gather
{{end}}

# FIXME: is this needed?
  - module:
      path: /modules/measurements.yaml
      params:
        action: gather
        group: {{$groupName}}
