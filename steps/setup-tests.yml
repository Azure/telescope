parameters:
- name: cloud
  type: string
- name: region
  type: string
- name: test_modules_dir
  type: string
  default: ''
- name: run_id
  type: string
  default: ''
- name: base_run_id
  type: string
  default: ''
- name: retry_attempt_count
  type: number
  default: 3
- name: credential_type
  type: string
- name: ssh_key_enabled
  type: boolean

steps:
- script: |
    echo "DEBUG: Input run_id parameter: '$RUN_ID'"
    echo "DEBUG: Input base_run_id parameter: '$BASE_RUN_ID'"
    
    # Priority: use run_id if provided, otherwise use base_run_id + job suffix, otherwise generate fallback
    if [ -n "$RUN_ID" ] && [ "$RUN_ID" != " " ] && [ "$RUN_ID" != "-" ]; then
      run_id=$RUN_ID
      echo "Using provided run_id: $run_id"
    elif [ -n "$BASE_RUN_ID" ] && [ "$BASE_RUN_ID" != " " ]; then
      job_suffix=$(echo "$(System.JobId)" | cut -c1-5)
      run_id="${BASE_RUN_ID}-${job_suffix}"
      echo "Using base_run_id ($BASE_RUN_ID) + job suffix ($job_suffix): $run_id"
    else
      echo "WARNING: Both run_id and base_run_id are empty, generating fallback timestamp-based ID"
      # Generate timestamp-based ID as fallback (MMddHHmmss format + suffix)
      timestamp=$(date +%m%d%H%M%S)
      full_guid=$(uuidgen)
      suffix=$(echo "$full_guid" | tr -d '-' | cut -c1-5)
      run_id="${timestamp}-${suffix}"
      echo "Generated fallback run_id: $run_id"
    fi
    echo "Final Run ID: $run_id"
    echo "##vso[task.setvariable variable=RUN_ID]$run_id"
    
    # When reusing clusters, validate BASE_RUN_ID is set
    if [ "${REUSE_CLUSTER:-false}" == "true" ]; then
      if [ -z "$BASE_RUN_ID" ] || [ "$BASE_RUN_ID" = " " ]; then
        echo "ERROR: REUSE_CLUSTER is true but BASE_RUN_ID is not set"
        exit 1
      fi
      echo "Cluster reuse enabled. Shared resource group name: $BASE_RUN_ID"
      echo "This job's unique RUN_ID: $run_id (for test result isolation)"
    fi
  displayName: "Set Run ID"
  env:
    RUN_ID: ${{ parameters.run_id }}
    BASE_RUN_ID: ${{ parameters.base_run_id }}
    REUSE_CLUSTER: $(reuse_cluster)

- script: |
    run_url="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=logs&j=$(System.JobId)"
    echo "Run URL: $run_url"
    echo "##vso[task.setvariable variable=RUN_URL]$run_url"

    code_url="$(Build.Repository.Uri)/commit/$(Build.SourceVersion)"
    echo "Code URL: $code_url"
    echo "##vso[task.setvariable variable=CODE_URL]$code_url"
  displayName: "Set Run URL & Code URL"

- script: |
    test_results_directory=$(Pipeline.Workspace)/s/$(RUN_ID)
    mkdir -p $test_results_directory
    echo "Test Results directory: $test_results_directory"
    echo "##vso[task.setvariable variable=TEST_RESULTS_DIR]$test_results_directory"

    test_results_file=$test_results_directory/results.json

    echo "Test Results file: $test_results_file"
    echo "##vso[task.setvariable variable=TEST_RESULTS_FILE]$test_results_file"
  displayName: 'Set Test Results Directory'

- script: |
    python3 --version && pip3 --version
    jq --version
  displayName: "Check Dependencies"

- script: |
    set -e
    if [ -f "$(Pipeline.Workspace)/s/modules/python/requirements.txt" ]; then
      pip3 install -r $(Pipeline.Workspace)/s/modules/python/requirements.txt
    fi

    sudo apt-get -y install bc
  displayName: "Install Dependencies"

- template: /steps/cloud/${{ parameters.cloud }}/login.yml
  parameters:
    region: ${{ parameters.region }}
    credential_type: ${{ parameters.credential_type }}

- script: |
    if [ -n "${TEST_MODULES_DIR}" ]; then
      test_modules_directory=$(Pipeline.Workspace)/s/${TEST_MODULES_DIR}
    else
      test_modules_directory=$(Pipeline.Workspace)/s/modules/bash
    fi
    echo "Script modules directory: $test_modules_directory"
    echo "##vso[task.setvariable variable=TEST_MODULES_DIR]$test_modules_directory"
  displayName: 'Set Script Module Directory'
  env:
    TEST_MODULES_DIR: ${{ parameters.test_modules_dir }}

- ${{ if eq(parameters.ssh_key_enabled, true) }}:
  - template: /steps/ssh/setup-key.yml
    parameters:
      cloud: ${{ parameters.cloud }}
