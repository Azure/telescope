parameters:
  - name: cloud
    type: string
    default: ""
  - name: engine_input
    type: object
    default: {}
  - name: region
    type: string

steps:
  - script: |
      echo "Set the start time for test execution"
      startTimestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      echo "Start: $startTimestamp"
      echo "##vso[task.setvariable variable=SLO_START_TIME]$startTimestamp"
    displayName: set up timestamp variable

  - script: |
      set -eo pipefail
      set -x
      
      # Get job suffix directly from System.JobId (same as in Set Run ID phase)
      export CL2_JOB_INDEX=$(echo "$(System.JobId)" | cut -c1-5)
      echo "Job index (from System.JobId): $CL2_JOB_INDEX"
      
      # Add signal handler for graceful cancellation
      trap 'echo "Benchmark execution cancelled by user"; exit 143' SIGTERM SIGINT

      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE configure \
        $CPU_PER_NODE $NODE_COUNT $PODS_PER_STEP $PODS_PER_NODE ${MAX_PODS:-0} \
        $REPEATS $TEST_TIMEOUT $CLOUD $CILIUM_ENABLED ${SCRAPE_CONTAINERD:-False} \
        $SERVICE_TEST ${CNP_TEST:-False} ${CCNP_TEST:-False} ${DS_TEST:-False} \
        ${NUM_CNPS:-0} ${NUM_CCNPS:-0} ${DUALSTACK:-False} ${PODS_PER_PNI:-0} ${EXISTING_PODS:-0} ${CL2_CONFIG_DIR}/overrides.yaml
      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE execute \
        ${CL2_IMAGE} ${CL2_CONFIG_DIR} $CL2_REPORT_DIR $CL2_CONFIG_FILE \
        ${HOME}/.kube/config $CLOUD ${SCRAPE_CONTAINERD:-False}
    workingDirectory: modules/python
    env:
      ${{ if eq(parameters.cloud, 'azure') }}:
        CLOUD: aks
      ${{ else }}:
        CLOUD: ${{ parameters.cloud }}
      REGION: ${{ parameters.region }}
      PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/clusterloader2/swiftv2-slo/slo.py
      CL2_IMAGE: ${{ parameters.engine_input.image }}
      CL2_CONFIG_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/swiftv2-slo/config
      CL2_REPORT_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/swiftv2-slo/results
      CL2_DATAPATH_REPORTER_IMAGE: $(DATAPATH_REPORTER_IMAGE)
      CL2_NGINX_IMAGE: $(NGINX_IMAGE)
      CL2_PROBE_TARGET_URL: $(PROBE_TARGET_URL)
      CL2_PROBE_TIMEOUT: $(PROBE_TIMEOUT)
      CL2_DEVICE_PLUGIN: $(DEVICE_PLUGIN)
    displayName: "Run Benchmark (SwiftV2)"