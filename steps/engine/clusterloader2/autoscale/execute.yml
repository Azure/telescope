parameters:
  - name: cloud
    type: string
    default: ""
  - name: engine_input
    type: object
    default: {}
  - name: region
    type: string

steps:
  - script: |
      set -eo pipefail


      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE override \
        ${CPU_PER_NODE:-0} ${NODE_COUNT:-0} ${POD_COUNT:-0} \
        $SCALE_UP_TIMEOUT $SCALE_DOWN_TIMEOUT \
        $LOOP_COUNT "${NODE_LABEL_SELECTOR:-""}" "$NODE_SELECTOR" ${CL2_CONFIG_DIR}/overrides.yaml ${WARMUP_DEPLOYMENT:-false} ${CL2_CONFIG_DIR} --os_type ${OS_TYPE:-linux} --warmup_deployment_template ${WARMUP_DEPLOYMENT_TEMPLATE:-""} --deployment_template ${DEPLOYMENT_TEMPLATE:-""} \
        --pod_cpu_request ${POD_CPU_REQUEST:-0} --pod_memory_request ${POD_MEMORY_REQUEST:-""} --cl2_config_file ${CL2_CONFIG_FILE:-config.yaml} --enable_prometheus ${ENABLE_PROMETHEUS:-False}

      # Note: cluster loader2 newest image is conflicted with service monitors and prometheus 
      # to enable prometheus scraping, we need to clean up existing servicemonitors pod first
      # Clean up the conflicting master ServiceMonitor before Prometheus deploys
      if [ "${ENABLE_PROMETHEUS}" = "True" ]; then
        echo "Removing conflicting master ServiceMonitor..."
        kubectl delete servicemonitor master -n monitoring --ignore-not-found=true || true
        sleep 2
      fi

      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE execute \
        ${CL2_IMAGE} ${CL2_CONFIG_DIR} $CL2_REPORT_DIR ${HOME}/.kube/config $CLOUD --cl2_config_file ${CL2_CONFIG_FILE:-config.yaml} --enable_prometheus ${ENABLE_PROMETHEUS:-False} --scrape_kubelets ${SCRAPE_KUBELETS:-False} --scrape_ksm ${SCRAPE_KSM:-False}
    workingDirectory: modules/python
    env:
      ${{ if eq(parameters.cloud, 'azure') }}:
        CLOUD: aks
      ${{ else }}:
        CLOUD: ${{ parameters.cloud }}
      REGION: ${{ parameters.region }}
      PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/clusterloader2/autoscale/autoscale.py
      CL2_IMAGE: ${{ parameters.engine_input.image }}
      CL2_CONFIG_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/autoscale/config
      CL2_REPORT_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/autoscale/results
    displayName: "Run Benchmark"
