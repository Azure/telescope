parameters:
- name: cloud
  type: string
  default: ''
- name: engine_input
  type: object
  default: {}
- name: region
  type: string

steps:
- script: |
    set -eo pipefail

    CL2_CONFIG_DIR="$(Pipeline.Workspace)/s/modules/python/clusterloader2/autoscale/config${CL2_CONFIG_SUB_DIR}"
    echo "CL2 Config Dir: $CL2_CONFIG_DIR"
    echo "CL2 Config Sub Dir": $CL2_CONFIG_SUB_DIR

    PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE override \
      $CPU_PER_NODE $NODE_COUNT $POD_COUNT \
      $SCALE_UP_TIMEOUT $SCALE_DOWN_TIMEOUT \
      $LOOP_COUNT "$NODE_LABEL_SELECTOR" "$NODE_SELECTOR" ${CL2_CONFIG_DIR}/overrides.yaml ${WARMUP_DEPLOYMENT:-false} ${CL2_CONFIG_DIR}
    PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE execute \
      ${CL2_IMAGE} ${CL2_CONFIG_DIR} $CL2_REPORT_DIR ${HOME}/.kube/config $CLOUD
  workingDirectory: modules/python
  env:
    ${{ if eq(parameters.cloud, 'azure') }}:
      CLOUD: aks
    ${{ else }}:
      CLOUD: ${{ parameters.cloud }}
    REGION: ${{ parameters.region }}
    PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/clusterloader2/autoscale/autoscale.py
    CL2_IMAGE: ${{ parameters.engine_input.image }}
    #${{ if eq(parameters.engine_input.cl2_config_directory, '') }}:
    #CL2_CONFIG_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/autoscale/config${{ parameters.engine_input.cl2_config_directory }}
    ${{ if eq(parameters.engine_input.cl2_config_dir, 'automatic') }}:
      CL2_CONFIG_SUB_DIR: /automatic
    CL2_REPORT_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/autoscale/results
  displayName: "Run Benchmark"
