steps:
- script: |

    kubectl delete --all nodeclaim --ignore-not-found
    kubectl delete --all nodepool --ignore-not-found

    # Get all Karpenter nodes
    NODES=$(kubectl get nodes -l karpenter.sh/nodepool -o jsonpath='{.items[*].metadata.name}')
    for NODE in $NODES; do
      # Extract the instance ID
      INSTANCE_ID=$(kubectl get node "$NODE" -o json | jq -r '.spec.providerID' | cut -d '/' -f5)

      if [ -n "$INSTANCE_ID" ]; then
        echo "Terminating instance: $INSTANCE_ID"
        # Terminate the instance
        aws ec2 terminate-instances --instance-ids "$INSTANCE_ID"
      fi
    done

    sleep 120
  displayName: "Cleanup Resources"
  condition: always()

- template: /steps/cloud/aws/cleanup-eni.yml
