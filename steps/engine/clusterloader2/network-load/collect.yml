parameters:
  - name: cloud
    type: string
    default: ""
  - name: region
    type: string
  - name: engine_input
    type: object
    default: {}

steps:
  - template: /steps/cloud/${{ parameters.cloud }}/collect-cloud-info.yml
    parameters:
      region: ${{ parameters.region }}
  - bash: |
      set -eo pipefail
      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE collect \
        --cl2-report-dir $CL2_REPORT_DIR \
        --cloud-info "$CLOUD_INFO" \
        --run-id $RUN_ID \
        --run-url $RUN_URL \
        --result-file $TEST_RESULTS_FILE \
        --test-type $TEST_TYPE \
        --deployment-recreation-count $DEPLOYMENT_RECREATION_COUNT \
        --node-count $NODE_COUNT \
        --fortio-namespaces $FORTIO_NAMESPACES \
        --fortio-server-deployments $FORTIO_SERVER_DEPLOYMENTS \
        --fortio-client-deployments $FORTIO_CLIENT_DEPLOYMENTS \
        --fortio-server-replicas-per-deployment $FORTIO_SERVER_REPLICAS_PER_DEPLOYMENT \
        --fortio-client-replicas-per-deployment $FORTIO_CLIENT_REPLICAS_PER_DEPLOYMENT \
        --fortio-client-queries-per-second $FORTIO_CLIENT_QUERIES_PER_SECOND \
        --apply-fqdn-cnp $APPLY_FQDN_CNP
    workingDirectory: modules/python
    displayName: Python Collect Script
    env:
      CLOUD: ${{ parameters.cloud }}
      RUN_URL: $(RUN_URL)
      PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/clusterloader2/network-load/network_load.py
      CL2_REPORT_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/network-load/results
      displayName: "Collect Results"
