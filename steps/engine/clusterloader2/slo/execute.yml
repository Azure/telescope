parameters:
  - name: cloud
    type: string
    default: ""
  - name: engine_input
    type: object
    default: {}
  - name: region
    type: string
  - name: pods_per_node
    type: number
    default: 50  # Default value for PODS_PER_NODE
  - name: no_of_namespaces
    type: number
    default: 1  # Default value for NO_OF_NAMESPACES
  - name: total_network_policies
    type: number
    default: 0  # Default value for TOTAL_NETWORK_POLICIES
  - name: network_test
    type: boolean
    default: false  # Default value for NETWORK_TEST

steps:
  - script: |
      set -eo pipefail

      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE configure \
        $CPU_PER_NODE $NODE_COUNT $NODE_PER_STEP $MAX_PODS $PODS_PER_NODE \
        $REPEATS $SCALE_TIMEOUT $NO_OF_NAMESPACES $TOTAL_NETWORK_POLICIES $CLOUD $CILIUM_ENABLED \
        $SERVICE_TEST $NETWORK_TEST ${CL2_CONFIG_DIR}/overrides.yaml
      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE execute \
        ${CL2_IMAGE} ${CL2_CONFIG_DIR} $CL2_REPORT_DIR $CL2_CONFIG_FILE \
        ${HOME}/.kube/config $CLOUD
    workingDirectory: modules/python/clusterloader2
    env:
      ${{ if eq(parameters.cloud, 'azure') }}:
        CLOUD: aks
      ${{ else }}:
        CLOUD: ${{ parameters.cloud }}
      REGION: ${{ parameters.region }}
      PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/clusterloader2/slo/slo.py
      CL2_IMAGE: ${{ parameters.engine_input.image }}
      CL2_CONFIG_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/slo/config
      CL2_REPORT_DIR: $(Pipeline.Workspace)/s/modules/python/clusterloader2/slo/results
      PODS_PER_NODE: ${{ parameters.pods_per_node }}
      NO_OF_NAMESPACES: ${{ parameters.no_of_namespaces }}
      TOTAL_NETWORK_POLICIES: ${{ parameters.total_network_policies }}  
      NETWORK_TEST: ${{ parameters.network_test }}
      CL2_CONFIG_FILE: load-config.yaml
    displayName: "Run Benchmark"
