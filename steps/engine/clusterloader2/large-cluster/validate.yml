parameters:
  - name: desired_nodes
    type: number
  - name: validation_timeout_in_minutes
    type: number
    default: 10

steps:
  - script: |
      set -eo pipefail

      if [ -z "$CUSTOM_DESIRED_NODES" ]; then
        VALIDATE_DESIRED_NODES=$DESIRED_NODES
      else
        VALIDATE_DESIRED_NODES=$CUSTOM_DESIRED_NODES
      fi

      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE validate \
        --node_count $VALIDATE_DESIRED_NODES \
        --operation_timeout $VALIDATION_TIMEOUT_IN_MINUTES
    workingDirectory: modules/python
    timeoutInMinutes: ${{ parameters.validation_timeout_in_minutes }}
    displayName: "Validate node count"
    env:
      DESIRED_NODES: ${{ parameters.desired_nodes }}
      VALIDATION_TIMEOUT_IN_MINUTES: ${{ parameters.validation_timeout_in_minutes }}
      PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/clusterloader2/large_cluster/large_cluster.py
