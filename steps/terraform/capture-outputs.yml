parameters:
- name: regions
  type: object

steps:
- script: |
    set -eo pipefail

    cd "$TERRAFORM_WORKING_DIRECTORY"
    for region in $(echo "$REGIONS" | jq -r '.[]'); do
      terraform workspace select "$region" >/dev/null

      jumpbox_output=$(terraform output -json jumpbox_connection_info 2>/dev/null || echo '{}')

      if [ -z "$jumpbox_output" ] || [ "$jumpbox_output" = "{}" ] || [ "$jumpbox_output" = "null" ]; then
        echo "No jumpbox output for region $region"
        continue
      fi

      # Check if output has any keys
      key_count=$(echo "$jumpbox_output" | jq 'keys | length' 2>/dev/null || echo "0")
      if [ "$key_count" = "0" ]; then
        echo "Empty jumpbox config for region $region"
        continue
      fi

      first_jumpbox=$(echo "$jumpbox_output" | jq -c 'to_entries[0] // null')
      if [ "$first_jumpbox" = "null" ] || [ -z "$first_jumpbox" ]; then
        echo "No jumpbox entries for region $region"
        continue
      fi

      host=$(echo "$first_jumpbox" | jq -r '.value.public_ip // empty')
      username=$(echo "$first_jumpbox" | jq -r '.value.username // "azureuser"')
      role=$(echo "$first_jumpbox" | jq -r '.key // empty')

      if [ -z "$host" ]; then
        echo "No public IP for jumpbox in region $region"
        continue
      fi

      echo "Jumpbox detected for role $role at $host"
      echo "  JUMPBOX_HOST: $host"
      echo "  JUMPBOX_USERNAME: $username"
      echo "  JUMPBOX_ROLE: $role"
      echo "##vso[task.setvariable variable=JUMPBOX_HOST]$host"
      echo "##vso[task.setvariable variable=JUMPBOX_USERNAME]$username"
      echo "##vso[task.setvariable variable=JUMPBOX_ROLE]$role"

      break
    done
  displayName: "Capture Terraform outputs"
  condition: ne(variables['SKIP_RESOURCE_MANAGEMENT'], 'true')
  env:
    REGIONS: ${{ convertToJson(parameters.regions) }}
    TERRAFORM_WORKING_DIRECTORY: $(TERRAFORM_WORKING_DIRECTORY)
