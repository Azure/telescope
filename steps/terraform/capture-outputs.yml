parameters:
- name: regions
  type: object

steps:
- script: |
    set -eo pipefail

    cd "$TERRAFORM_WORKING_DIRECTORY"
    for region in $(echo "$REGIONS" | jq -r '.[]'); do
      terraform workspace select "$region" >/dev/null

      jumpbox_output=$(terraform output -json jumpbox_connection_info 2>/dev/null || echo '')
      kubeconfig_output=$(terraform output -json aks_kubeconfig_paths 2>/dev/null || echo '')

      if [ -z "$jumpbox_output" ]; then
        continue
      fi

      first_jumpbox=$(echo "$jumpbox_output" | jq -c '.value | to_entries[0] // null')
      if [ "$first_jumpbox" = "null" ]; then
        continue
      fi

      host=$(echo "$first_jumpbox" | jq -r '.value.public_ip')
      username=$(echo "$first_jumpbox" | jq -r '.value.username // "azureuser"')
      role=$(echo "$first_jumpbox" | jq -r '.key')

      if [ -z "$host" ] || [ "$host" = "null" ]; then
        continue
      fi

      echo "Jumpbox detected for role $role at $host"
      echo "##vso[task.setvariable variable=JUMPBOX_HOST]$host"
      echo "##vso[task.setvariable variable=JUMPBOX_USERNAME]$username"
      echo "##vso[task.setvariable variable=JUMPBOX_ROLE]$role"

      if [ -n "$kubeconfig_output" ]; then
        kubeconfig_path=$(echo "$kubeconfig_output" | jq -r --arg role "$role" '.value[$role] // empty')
        if [ -n "$kubeconfig_path" ]; then
          echo "##vso[task.setvariable variable=CL2_KUBECONFIG_PATH]$kubeconfig_path"
          echo "##vso[task.setvariable variable=JUMPBOX_SOURCE_KUBECONFIG]$kubeconfig_path"
        fi
      fi

      break
    done
  displayName: "Capture Terraform outputs"
  condition: ne(variables['SKIP_RESOURCE_MANAGEMENT'], 'true')
  env:
    REGIONS: ${{ convertToJson(parameters.regions) }}
    TERRAFORM_WORKING_DIRECTORY: $(TERRAFORM_WORKING_DIRECTORY)
