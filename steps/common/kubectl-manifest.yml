parameters:
  - name: action
    type: string
    default: "apply"
  - name: cluster_context
    type: string
    default: ""
  - name: manifest_file
    type: string
  - name: namespace
    type: string
    default: default
  - name: wait_resource
    type: string
    default: pod
  - name: wait_condition
    type: string
    default: "condition=Ready"
  - name: timeout
    type: string
    default: 60s

steps:
- script: |
    set -eo pipefail
    echo "Kubeconfig file: '$KUBECONFIG'"
    kubectl config view --kubeconfig /home/AzDevOps/.kube/config
    kubectl --kubeconfig /home/AzDevOps/.kube/config --context="$CLUSTER_CONTEXT" create namespace "$NAMESPACE" || true

    # Wait all nodes to be ready before applying the manifest
    kubectl --kubeconfig /home/AzDevOps/.kube/config --context="$CLUSTER_CONTEXT" wait --for=condition=Ready nodes --timeout=600s

    kubectl --kubeconfig /home/AzDevOps/.kube/config --context="$CLUSTER_CONTEXT" $ACTION -f "$MANIFEST_FILE"

    # if ACTION is apply and WAIT_CONDITION and WAIT_RESOURCE is not empty then wait for the resource to be ready
    if [ "$ACTION" = "apply" ] && [ -n "$WAIT_CONDITION" ] && [ -n "$WAIT_RESOURCE" ]; then
      kubectl --kubeconfig /home/AzDevOps/.kube/config --context="$CLUSTER_CONTEXT" wait --for="$WAIT_CONDITION" "$WAIT_RESOURCE" --timeout="$TIMEOUT" -n "$NAMESPACE"
    fi
  displayName: "${{ parameters.action }} kubectl manifest"
  # always runs if action is 'delete'
  condition: or(succeeded(), and(always(), eq('${{ parameters.action }}', 'delete')))
  env:
    ACTION: ${{ parameters.action }}
    CLUSTER_CONTEXT: ${{ parameters.cluster_context }}
    MANIFEST_FILE: ${{ parameters.manifest_file }}
    NAMESPACE: ${{ parameters.namespace }}
    WAIT_RESOURCE: ${{ parameters.wait_resource }}
    WAIT_CONDITION: ${{ parameters.wait_condition }}
    TIMEOUT: ${{ parameters.timeout }}
