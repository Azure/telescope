parameters:
- name: regions
  type: object
  default: {}
- name: cloud
  type: string
- name: retry_attempt_count
  type: number
  default: 3
- name: credential_type
  type: string
  default: managed_identity

steps:
- script: |
    echo "==================================================================="
    echo "Starting cleanup process for resource group: $RESOURCE_GROUP_NAME"
    echo "Cleanup will proceed even if pipeline was cancelled"
    echo "==================================================================="
  displayName: "Cleanup Notice"
  condition: always()

- script: |
    set -eu
    
    # Signal handler - still try to complete cleanup even if cancelled again
    trap 'echo "Cleanup received cancellation signal but will attempt to continue"; sleep 2' SIGTERM SIGINT
    
    for attempt in $(seq 1 5); do
      echo "Attempting to execute subnetdelegator DELETE command: $attempt/5"
      script --return --quiet -c "az containerapp exec -n subnetdelegator-westus-u3h4j -g subnetdelegator-westus --command 'curl -X DELETE http://localhost:8080/DelegatedSubnet/%2Fsubscriptions%2F9b8218f9-902a-4d20-a65c-e98acec5362f%2FresourceGroups%2F$RESOURCE_GROUP_NAME%2Fproviders%2FMicrosoft.Network%2FvirtualNetworks%2Fcustvnet%2Fsubnets%2Fscaledel'" /dev/null && break || echo "Command failed, retrying..."
      sleep 30
    done
  displayName: "Delete SAL Ping"
  condition: and(always(), eq(variables['CREATE_CUSTOMER_RESOURCES'], 'true'))
  continueOnError: true

- task: AzureCLI@2
  displayName: "Cleanup Swiftv2 Workloads"
  condition: and(always(), ${{ eq(parameters.cloud, 'azure') }})
  continueOnError: true
  inputs:
    azureSubscription: $(AZURE_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -eu
      
      trap 'echo "Cleanup received cancellation signal but will attempt to continue"; sleep 2' SIGTERM SIGINT
      
      export RG="$RESOURCE_GROUP_NAME"
      export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
      export DELETE_NODEPOOLS="true"
      export DELETE_BUFFER_POOL="true"
      
      SCRIPT_PATH="$(Build.SourcesDirectory)/swiftv2kubeobjects/cleanup-swiftv2-workloads.sh"
      if [[ -f "$SCRIPT_PATH" ]]; then
        chmod +x "$SCRIPT_PATH"
        "$SCRIPT_PATH" || echo "Cleanup script completed with warnings"
      else
        echo "WARNING: Cleanup script not found at $SCRIPT_PATH"
      fi

- task: AzureCLI@2
  displayName: "Force Cleanup Azure Resources"
  condition: and(always(), ${{ eq(parameters.cloud, 'azure') }})
  continueOnError: true
  inputs:
    azureSubscription: $(AZURE_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -eu
      
      trap 'echo "Cleanup received cancellation signal but will attempt to continue"; sleep 2' SIGTERM SIGINT
      
      export RG="$RESOURCE_GROUP_NAME"
      export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
      
      SCRIPT_PATH="$(Build.SourcesDirectory)/swiftv2kubeobjects/cleanup-azure-resources.sh"
      if [[ -f "$SCRIPT_PATH" ]]; then
        chmod +x "$SCRIPT_PATH"
        "$SCRIPT_PATH" || echo "Cleanup script completed with warnings"
      else
        echo "WARNING: Cleanup script not found at $SCRIPT_PATH"
      fi

- task: AzureCLI@2
  displayName: "Destroy Resource Group"
  condition: and(always(), ${{ eq(parameters.cloud, 'azure') }})
  continueOnError: true
  inputs:
    azureSubscription: $(AZURE_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -eu
      
      trap 'echo "Cleanup received cancellation signal but will attempt to continue"; sleep 2' SIGTERM SIGINT
      
      echo "Delete resource group $RESOURCE_GROUP_NAME"
      for attempt in $(seq 1 5); do
        echo "Attempting to delete resource group: $attempt/5"
        if az group delete --name $RESOURCE_GROUP_NAME --yes; then
          echo "Resource group deleted successfully"
          break
        else
          echo "Resource group deletion failed on attempt $attempt"
          if [ $attempt -lt 5 ]; then
            echo "Waiting 120 seconds before retry..."
            sleep 120
          fi
        fi
      done
