parameters:
- name: regions
  type: object
  default: {}
- name: cloud
  type: string
- name: terraform_arguments
  type: string
  default: ''
- name: retry_attempt_count
  type: number
  default: 3
- name: credential_type
  type: string
  default: managed_identity

steps:
- template: /steps/terraform/run-command.yml
  parameters:
    command: destroy
    arguments: ${{ parameters.terraform_arguments }}
    regions: ${{ parameters.regions }}
    cloud: ${{ parameters.cloud }}
    retry_attempt_count: ${{ parameters.retry_attempt_count }}
    credential_type: ${{ parameters.credential_type }}
- script: |
    set -eu
    for attempt in $(seq 1 5); do
      echo "Attempting to execute subnetdelegator DELETE command: $attempt/5"
      script --return --quiet -c "az containerapp exec -n subnetdelegator-westus-u3h4j -g subnetdelegator-westus --command 'curl -X DELETE http://localhost:8080/DelegatedSubnet/%2Fsubscriptions%2F9b8218f9-902a-4d20-a65c-e98acec5362f%2FresourceGroups%2F$RUN_ID%2Fproviders%2FMicrosoft.Network%2FvirtualNetworks%2Fcustvnet%2Fsubnets%2Fscaledel'" /dev/null && break || echo "Command failed, retrying..."
      sleep 30
    done
  displayName: "Delete SAL Ping"
  condition: and(eq(variables['CREATE_CUSTOMER_RESOURCES'], 'true'), eq(variables['CLEANUP_RESOURCES'], 'true'))
- script: |
    set -eu
    echo "Delete resource group $RUN_ID"
    az group delete --name $RUN_ID --yes
  displayName: "Destroy Resource Group"
  condition: and(${{ eq(parameters.cloud, 'azure') }}, eq(variables['CLEANUP_RESOURCES'], 'true'))

- ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
  - template: /steps/collect-terraform-operation-metadata.yml
    parameters:
      cloud: ${{ parameters.cloud }}
      credential_type: ${{ parameters.credential_type }}
