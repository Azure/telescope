parameters:
- name: start_variable_name
  type: string
  default: 'STEP_START_EPOCH'
- name: duration_variable_name
  type: string
  default: 'STEP_DURATION_MINUTES'
- name: display_name
  type: string
  default: 'Calculate step execution duration'

steps:
- script: |
    set -eo pipefail
    # Get the start epoch from the variable
    start_epoch="$(${{ parameters.start_variable_name }})"
    echo "Start epoch time: $start_epoch"
          
    duration_minutes=$(PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE "$start_epoch")
    
    if [ $? -ne 0 ]; then
        echo "Error: Failed to calculate duration"
        exit 1
    fi
    
    echo "Calculated duration: $duration_minutes minutes"
    
    # Set variable for use in subsequent steps
    echo "##vso[task.setvariable variable=${{ parameters.duration_variable_name }}]$duration_minutes"
  workingDirectory: modules/python/
  displayName: '${{ parameters.display_name }}'
  continueOnError: true
  env:
    PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/utils/calculate_duration.py