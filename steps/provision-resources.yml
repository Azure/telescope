parameters:
- name: cloud
  type: string
- name: regions
  type: object
- name: retry_attempt_count
  type: number
  default: 3
- name: credential_type
  type: string
  default: managed_identity

steps:

# Always set RESOURCE_GROUP_NAME for use in all subsequent steps
- script: |
    # Determine resource group name
    # BASE_RUN_ID is always generated by the pipeline and used for resource group naming.
    # All jobs in a matrix share the same BASE_RUN_ID so they can find/reuse the same cluster.
    if [ -z "${BASE_RUN_ID:-}" ]; then
      echo "ERROR: BASE_RUN_ID not set"
      exit 1
    fi
    RESOURCE_GROUP_NAME="$BASE_RUN_ID"
    echo "Using resource group: $RESOURCE_GROUP_NAME"
    echo "##vso[task.setvariable variable=RESOURCE_GROUP_NAME]$RESOURCE_GROUP_NAME"
  displayName: "Set Resource Group Name"

- script: |
    # Set deletion due time to 1 week from now
    deletion_due_time=$(date -u -d "+1 week" +'%Y-%m-%dT%H:%M:%SZ')
    echo "Deletion Due Time: $deletion_due_time"
    echo "##vso[task.setvariable variable=DELETION_DUE_TIME]$deletion_due_time"

    # Set owner as the person running the ADO pipeline
    owner="$BUILD_REQUESTED_FOR"
    echo "Owner: $owner"
    echo "##vso[task.setvariable variable=OWNER]$owner"
  displayName: "Get Deletion Due Time and Owner"
  condition: ne(variables['SKIP_RESOURCE_MANAGEMENT'], 'true')
  env:
    region: ${{ parameters.regions[0] }}
    BUILD_REQUESTED_FOR: $(Build.RequestedFor)

- script: |
    set -eu
    
    # Check if resource group already exists
    if az group show --name "$RESOURCE_GROUP_NAME" &>/dev/null; then
      echo "Resource group $RESOURCE_GROUP_NAME already exists, skipping creation"
    else
      echo "Creating resource group $RESOURCE_GROUP_NAME"
      az group create --name "$RESOURCE_GROUP_NAME" --location $region \
        --tags "run_id=$RESOURCE_GROUP_NAME" "scenario=${SCENARIO_TYPE}-${SCENARIO_NAME}" "owner=${OWNER}" "creation_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "deletion_due_time=${DELETION_DUE_TIME}" "SkipAKSCluster=1"
    fi
  displayName: "Ensure Resource Group"
  condition: and(${{ eq(parameters.cloud, 'azure') }}, ne(variables['SKIP_RESOURCE_MANAGEMENT'], 'true'))
  env:
    region: ${{ parameters.regions[0] }}
    
- script: |
    bash swiftv2kubeobjects/runCustomerSetup.sh
  displayName: "SetupCustomerResources"
  condition: eq(variables['CREATE_CUSTOMER_RESOURCES'], 'true')
  name: SetupCustomerResources

- script: |
    set -eu
    
    # Check if cluster already exists
    if az aks show --name "large" --resource-group "$RESOURCE_GROUP_NAME" &>/dev/null; then
      echo "AKS cluster 'large' already exists in $RESOURCE_GROUP_NAME, skipping creation"
    else
      echo "Creating AKS cluster..."
      bash swiftv2kubeobjects/createclusterforping.sh
    fi
  displayName: "Ensure AKS Cluster"
  condition: eq(variables['CREATESWIFTV2PING'], 'true')
  name: EnsureAKSCluster
  env:
    MAX_PODS: $(max_pods)
    DEVICE_PLUGIN: $(DEVICE_PLUGIN)

- script: |
    bash swiftv2kubeobjects/ensure-nodepools.sh
  displayName: "EnsureUserNodepools"
  condition: eq(variables['CREATESWIFTV2PING'], 'true')
  env:
    NODE_COUNT: $(node_count)
    VM_SKU: $(vm_sku)
    PODS_PER_NODE: $(pods_per_node)
    PROVISION_BUFFER_NODES: $(PROVISION_BUFFER_NODES)
    MAX_PODS: $(max_pods)
    DEVICE_PLUGIN: $(DEVICE_PLUGIN)
    REGION: ${{ parameters.regions[0] }}
    ROLE: slo