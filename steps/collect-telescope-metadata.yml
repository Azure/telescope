parameters:
- name: engine
  type: string
- name: topology
  type: string
- name: image
  type: string
- name: cloud
  type: string
- name: credential_type
  type: string
- name: regions
  type: object
steps:
- script: |
    telescope_metadata=$(jq -n \
      --arg run_id $RUN_ID \
      --arg run_url  $RUN_URL \
      --arg code_url  $CODE_URL \
      --arg reason $(Build.Reason) \
      --arg source_branch $(Build.SourceBranchName) \
      --arg requester "$(Build.RequestedFor)" \
      --arg scenario_name "$SCENARIO_NAME" \
      --arg scenario_type "$SCENARIO_TYPE" \
      --arg engine "$ENGINE" \
      --arg topology "$TOPOLOGY" \
      --arg engine_image "$ENGINE_IMAGE" \
      --arg cloud "$CLOUD" \
      --arg region "$(echo "$REGIONS" | jq -r '.[]')" \
      --arg pipeline_id "$(System.DefinitionId)" \
      --arg pipeline_name "$(Build.DefinitionName)" \
      --arg cron_schedule_display_name "$(Build.CronSchedule.DisplayName)" \
      --arg project_name "$(System.TeamProject)" \
      '{
      run_id: $run_id,
      run_url: $run_url,
      code_url: $code_url,
      reason: $reason,
      source_branch: $source_branch,
      requester: $requester,
      scenario_name: $scenario_name,
      scenario_type: $scenario_type,
      engine: $engine,
      topology: $topology,
      engine_image: $engine_image,
      cloud: $cloud,
      region: $region,
      pipeline_id: $pipeline_id,
      pipeline_name: $pipeline_name,
      cron_schedule_display_name: $cron_schedule_display_name,
      project_name: $project_name
      }' | jq 'with_entries(select(.value != null and .value != ""))' | jq -c .)
    echo "Telescope Metadata: $telescope_metadata"
    echo "$telescope_metadata" > $TEST_RESULTS_DIR/telescope_metadata.json
    echo "##vso[task.setvariable variable=TELESCOPE_METADATA_FILE]$TEST_RESULTS_DIR/telescope_metadata.json"
  displayName: "Collect Telescope Metadata"
  condition: always()
  env:
    ENGINE: ${{ parameters.engine }}
    TOPOLOGY: ${{ parameters.topology }}
    ENGINE_IMAGE: ${{ parameters.image }}
    CLOUD: ${{ parameters.cloud }}
    REGIONS: ${{ convertToJson(parameters.regions) }}

- script: |
    # Read the test results file and add the telescope metadata to it for each json record in the file
    set -eux
    jq --argfile telescope_metadata $(TELESCOPE_METADATA_FILE) \
      -c '. + {telescope_metadata: $telescope_metadata}' $(TEST_RESULTS_FILE) > temp-$RUN_ID.json \
       && mv temp-$RUN_ID.json $(TEST_RESULTS_FILE)
  displayName: "Add Telescope Metadata to Test Results"
  condition: always()

- ${{ if eq(variables['Build.SourceBranchName'], 'add-telescope-metadata') }}:
  - template: /steps/cloud/azure/upload-storage-account.yml
    parameters:
      source_file_name: $(TELESCOPE_METADATA_FILE)
      destination_file_name: $(RUN_ID).json
      subfolder: telescope-metadata
      credential_type: ${{ parameters.credential_type }}
      cloud: ${{ parameters.cloud }}
