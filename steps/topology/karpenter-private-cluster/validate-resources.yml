parameters:
- name: cloud
  type: string
- name: role
  type: string
  default: nap
- name: regions
  type: object
- name: engine
  type: string
  default: ''

steps:
- bash: |
    set -eu
    region="${{ parameters.regions[0] }}"
    echo "Get VM instance with role $ROLE and tag $RUN_ID in region $region."
    vm_id=$(az resource list --resource-type Microsoft.Compute/virtualMachines --location $region --query "[?(tags.run_id == '${RUN_ID}' && tags.jumpbox == 'true')].id" --output tsv)

    if [ -z "$vm_id" ]; then
      echo "##vso[task.logissue type=error;] VM instance with $ROLE role and tag $RUN_ID not found in region $region."
      exit 1
    fi

    echo "VM ID: $vm_id"
    vm_public_ip=$(az vm list-ip-addresses --ids $vm_id --query '[].virtualMachine.network.publicIpAddresses[0].ipAddress' -o tsv)
    echo "Public IP Address: $vm_public_ip"

    # Set Public IP as JUMPBOX_HOST directly as requested
    echo "##vso[task.setvariable variable=JUMPBOX_HOST;]${vm_public_ip}"
  displayName: "Get VM Info ${{ parameters.role }}"
  env:
    ROLE: ${{ lower(parameters.role) }}

# Update Kubeconfig on Jumpbox
- template: /steps/ssh/run-command.yml
  parameters:
    vm_ip: $(JUMPBOX_HOST)
    command: |
      set -e
      cloud-init status --wait || echo 'Warning: cloud-init finished with errors, but continuing anyway...'
      az login --identity --output none
      aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location '${{ parameters.regions[0] }}' --query "[?(tags.run_id == '$(RUN_ID)' && tags.role == '${{ parameters.role }}')].name" --output tsv)
      aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location '${{ parameters.regions[0] }}' --query "[?(tags.run_id == '$(RUN_ID)' && tags.role == '${{ parameters.role }}')].resourceGroup" --output tsv)
      if [ -z "$aks_name" ]; then echo "No AKS found with run_id=$(RUN_ID) and role=${{ parameters.role }}"; exit 1; fi
      echo "Found AKS: $aks_name in resource group: $aks_rg"
      echo 'Kubeconfig updated on jumpbox. Testing kubectl...'
      kubectl get ns

- template: /steps/ssh/run-command.yml
  parameters:
    vm_ip: $(JUMPBOX_HOST)
    command: "mkdir -p '/tmp/telescope-$(Build.BuildId)'"

- bash: |
    set -euo pipefail

    if [ -z "${SSH_KEY_PATH:-}" ] || [ ! -f "$SSH_KEY_PATH" ]; then
      echo "SSH_KEY_PATH is not set or file not found: ${SSH_KEY_PATH:-'(not set)'}" >&2
      exit 1
    fi

    if [ -z "${JUMPBOX_HOST:-}" ]; then
       echo "JUMPBOX_HOST is not set." >&2
       exit 1
    fi

    ssh_target="${JUMPBOX_USERNAME:-azureuser}@${JUMPBOX_HOST}"
    ssh_opts=(-i "$SSH_KEY_PATH" -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null")
    remote_root="/tmp/telescope-$(Build.BuildId)"
    remote_nodepool_file="${remote_root}/karpenter_nodepool.yml"

    echo "Uploading nodepool file to jumpbox ${JUMPBOX_HOST}..."
    scp "${ssh_opts[@]}" "$KARPENTER_NODEPOOL_FILE" "${ssh_target}:${remote_nodepool_file}"
  displayName: "Upload Karpenter config to Jumpbox"
  env:
    KARPENTER_NODEPOOL_FILE: $(Pipeline.Workspace)/s/scenarios/$(SCENARIO_TYPE)/$(SCENARIO_NAME)/kubernetes/karpenter_nodepool.${{ parameters.cloud }}.yml

- template: /steps/ssh/run-command.yml
  parameters:
    vm_ip: $(JUMPBOX_HOST)
    command: |
      set -e
      kubectl apply -f '/tmp/telescope-$(Build.BuildId)/karpenter_nodepool.yml'
      if [ -n "$(VM_SIZE)" ]; then
        echo "Patching nodepools with VM_SIZE=$(VM_SIZE)"
        kubectl patch nodepool default --type='json' -p="[{'op': 'replace', 'path': '/spec/template/spec/requirements/2/values', 'value': ['$(VM_SIZE)']}]"
        kubectl patch nodepool spot --type='json' -p="[{'op': 'replace', 'path': '/spec/template/spec/requirements/2/values', 'value': ['$(VM_SIZE)']}]"
      else
        echo "VM_SIZE is not set, skipping nodepool patch"
      fi
      kubectl get nodepool default -o yaml
      kubectl get nodepool spot -o yaml
