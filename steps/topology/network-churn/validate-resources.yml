parameters:
  - name: cloud
    type: string
  - name: engine
    type: string
  - name: regions
    type: object

steps:
  - template: /steps/cloud/${{ parameters.cloud }}/update-kubeconfig.yml
    parameters:
      role: net
      region: ${{ parameters.regions[0] }}

  - template: /steps/engine/clusterloader2/cilium/scale-cluster.yml
    parameters:
      role: net
      region: ${{ parameters.regions[0] }}
      nodes_per_nodepool: 240
      enable_autoscale: "false"

  - script: |
      #!/bin/bash
      set -e

      # Check if NPM_ENABLED environment variable is set to true
      if [[ "$NPM_ENABLED" == "True" ]]; then
        echo "NPM is enabled, applying Azure NPM configuration..."

        # Path to the NPM configuration file
        npm_config_file="$(Pipeline.Workspace)/s/scripts/azure-npm.yaml"

        # Check if the file exists
        if [[ -f "$npm_config_file" ]]; then
          echo "Applying NPM configuration from: $npm_config_file"
          kubectl apply -f "$npm_config_file"
          echo "Azure NPM configuration applied successfully!"
        else
          echo "Error: NPM configuration file not found at $npm_config_file"
          echo "Looking for file in current directory:"
          ls -la "$(Pipeline.Workspace)/s/scripts/"
          exit 1
        fi
      else
        echo "NPM is not enabled, skipping Azure NPM configuration."
      fi
    displayName: 'Apply Azure NPM Configuration (if enabled)'
    condition: and(succeeded(), eq('${{ parameters.cloud }}', 'azure'))
