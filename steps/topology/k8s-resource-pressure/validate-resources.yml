parameters:
- name: cloud
  type: string
- name: engine
  type: string
- name: regions
  type: object

steps:
- template: /steps/cloud/${{ parameters.cloud }}/update-kubeconfig.yml
  parameters:
    role: client
    region: ${{ parameters.regions[0] }}
- template: /steps/engine/clusterloader2/large-cluster/validate.yml
  parameters:
    desired_nodes: 3
- bash: |
    set -euo pipefail
    set -x

    flags_string=$(echo "$CUSTOM_EVICTION_FLAGS" | jq -r '
      def format_value(k; v):
        if (v|type) == "object" then
          (if (k == "eviction-hard") or (k == "eviction-soft") then "<"
          else "=" end) as $delim
          | (v | to_entries | map(.key + $delim + (.value|tostring)) | join(","))
        elif (v|type) == "array" then
          (v | map(tostring) | join(","))
        else
          (v | tostring)
        end;

      to_entries
      | map("--" + .key + "=" + (format_value(.key; .value)))
      | join(" ")
      ')

    printf '%s' "$flags_string" > "kubelet_flags.txt"

    helm upgrade --install kubelet-config-updater ./steps/topology/k8s-resource-pressure/chart \
      --namespace kube-system --create-namespace \
      --set-file kubeletFlags="kubelet_flags.txt"

    sleep 5

    kubectl get pods -A -o wide

  env:
    CUSTOM_EVICTION_FLAGS: $(CUSTOM_KUBELET_CONFIG)
    
  displayName: "Validate Kubelet Custom Config Applied"

# - script: |
#     # Deploy node-exporter via helm
#     helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
#     helm repo update
    
#     # Deploy to test nodes only (matching resource-consumer placement)
#     helm install node-exporter oci://ghcr.io/prometheus-community/charts/prometheus-node-exporter \
#       --namespace monitoring \
#       --create-namespace \
#       --set hostNetwork=true \
#       --set hostPID=true \
#       --set args[0]="--collector.pressure" \
#       --set-string nodeSelector.cri-resource-consume="true" \
#       --set tolerations[0].key="cri-resource-consume" \
#       --set tolerations[0].operator="Equal" \
#       --set-string tolerations[0].value="true" \
#       --set tolerations[0].effect="NoSchedule" \
#       --set tolerations[1].key="cri-resource-consume" \
#       --set tolerations[1].operator="Equal" \
#       --set-string tolerations[1].value="true" \
#       --set tolerations[1].effect="NoExecute" \
#       --wait
#   displayName: "Deploy node-exporter for PSI metrics"
