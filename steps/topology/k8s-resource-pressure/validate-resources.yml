parameters:
- name: cloud
  type: string
- name: engine
  type: string
- name: regions
  type: object

steps:
- template: /steps/cloud/${{ parameters.cloud }}/update-kubeconfig.yml
  parameters:
    role: client
    region: ${{ parameters.regions[0] }}
- template: /steps/engine/clusterloader2/large-cluster/validate.yml
  parameters:
    desired_nodes: 3
- bash: |
    set -euo pipefail
    set -x

    flags_string=$(echo "$CUSTOM_EVICTION_FLAGS" | jq -r '
      def format_value(k; v):
        if (v|type) == "object" then
          (if (k|test("eviction")) then "<"
          elif (k|test("reserved")) then "="
          else error("Unknown complex flag type for key: " + k) end) as $delim
          | (v | to_entries | map(.key + $delim + (.value|tostring)) | join(","))
        elif (v|type) == "array" then
          (v | map(tostring) | join(","))
        else
          (v | tostring)
        end;

      to_entries
      | map("--" + .key + "='" + (format_value(.key; .value)) + "'")
      | join(" ")
      ')

    helm upgrade --install kubelet-config-updater ./steps/topology/k8s-resource-pressure/chart \
      --namespace kube-system --create-namespace \
      --set kubeletFlags="$flags_string"
  env:
    CUSTOM_EVICTION_FLAGS: $(CUSTOM_KUBELET_CONFIG)
    
  displayName: "Validate Kubelet Custom Config Applied"
