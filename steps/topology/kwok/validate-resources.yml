parameters:
  - name: cloud
    type: string
  - name: engine
    type: string
  - name: regions
    type: object

steps:
  - template: /steps/cloud/${{ parameters.cloud }}/update-kubeconfig.yml
    parameters:
      role: client
      region: ${{ parameters.regions[0] }}

  - template: /steps/engine/clusterloader2/job_controller/validate.yml
    parameters:
      desired_nodes: 2
      node_label: default
  - template: /steps/engine/clusterloader2/job_controller/validate.yml
    parameters:
      desired_nodes: 1
      node_label: kwok

  - script: |
      set -eo pipefail

      if [ "$ENABLE_DRA" = "True" ]; then
        PYTHONPATH=$PYTHONPATH:$(pwd) python3 $KWOK_SCRIPT_FILE \
          --action create \
          --node-count $NODE_COUNT \
          --node-gpu ${NODE_GPU:-"0"} \
          --enable-dra
      else
        PYTHONPATH=$PYTHONPATH:$(pwd) python3 $KWOK_SCRIPT_FILE \
          --action create \
          --node-count $NODE_COUNT \
          --node-gpu ${NODE_GPU:-"0"}
      fi

    workingDirectory: modules/python
    env:
      KWOK_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/kwok/kwok.py
    displayName: "Create KWOK Nodes"

  - script: |
      set -eo pipefail
      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $KWOK_SCRIPT_FILE \
      --action validate \
      --node-count $NODE_COUNT
    workingDirectory: modules/python
    env:
      KWOK_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/kwok/kwok.py
    displayName: "Validate KWOK Nodes"
