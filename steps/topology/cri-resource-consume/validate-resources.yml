parameters:
- name: cloud
  type: string
- name: engine
  type: string
- name: regions
  type: object

steps:
- template: /steps/cloud/${{ parameters.cloud }}/update-kubeconfig.yml
  parameters:
    role: client
    region: ${{ parameters.regions[0] }}
- script: |
    node_rg=$(az aks show --resource-group $RUN_ID --name $AKS_NAME --query nodeResourceGroup --output tsv)
    vmss_list=$(az vmss list -g $node_rg --query [].name -o tsv | grep "userpool")
    for vmss in $vmss_list; do
      echo "Restarting nodepool $vmss"
      az vmss restart -g $node_rg --name $vmss
    done

    kubectl get nodes
  displayName: "Restart test nodepool"
