parameters:
- name: region
  type: string
- name: role
  type: string
- name: alias
  type: string
  default: ""

steps:
# Public cluster: fetch kubeconfig locally on agent
- script: |
    set -euo pipefail
    set -x

    region=${{ parameters.region }}

    aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
      --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$ROLE')].name" --output tsv)

    aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
      --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$ROLE')].resourceGroup" --output tsv)

    if [ -z "$aks_name" ]; then
        echo "##vso[task.logissue type=error;] No AKS instance with role $ROLE and tag $RUN_ID found in region $region."
        exit 1
    fi

    az aks get-credentials -n $aks_name -g $aks_rg ${ALIAS:+--context $ALIAS}
  env:
    ROLE: ${{ parameters.role }}
    ALIAS: ${{ parameters.alias }}
  displayName: "Update kubeconfig (local)"
  condition: eq(variables['JUMPBOX_HOST'], '')

# Private cluster: fetch kubeconfig on jumpbox via SSH
# Jumpbox uses Managed Identity for Azure authentication
- template: /steps/ssh/run-command.yaml
  parameters:
    vm_ip: $(JUMPBOX_HOST)
    command_array:
      - "cloud-init status --wait || echo 'Warning: cloud-init finished with errors, but continuing anyway...'"
      - "az login --identity --output none "
      - "aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location '${{ parameters.region }}' --query \"[?(tags.run_id == '$(RUN_ID)' && tags.role == '${{ parameters.role }}')].name\" --output tsv); aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location '${{ parameters.region }}' --query \"[?(tags.run_id == '$(RUN_ID)' && tags.role == '${{ parameters.role }}')].resourceGroup\" --output tsv)"
      - "if [ -z \"$aks_name\" ]; then echo \"No AKS found with run_id=$(RUN_ID) and role=${{ parameters.role }}\"; exit 1; fi"
      - "echo \"Found AKS: $aks_name in resource group: $aks_rg\""
      - "az aks get-credentials -n $aks_name -g $aks_rg ${{ if(ne(parameters.alias, ''), format('--context {0}', parameters.alias), '') }} --overwrite-existing"
      - "echo 'Kubeconfig updated on jumpbox. Testing kubectl...'"
      - kubectl get ns
