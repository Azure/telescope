parameters:
- name: region
  type: string
- name: role
  type: string
- name: alias
  type: string
  default: ""

steps:
# Public cluster: fetch kubeconfig locally on agent
- script: |
    set -euo pipefail
    set -x
    
    region=${{ parameters.region }}
    role=${{ parameters.role }}
    
    aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
      --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].name" --output tsv)

    aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
      --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].resourceGroup" --output tsv)

    if [ -z "$aks_name" ]; then
        echo "No AKS instance with role $role and tag $RUN_ID found in region $region."
        exit 1
    fi

    mkdir -p ~/.kube
    az aks get-credentials -n $aks_name -g $aks_rg --file ~/.kube/config
  env:
    ROLE: ${{ parameters.role }}
  displayName: "Update kubeconfig (local)"
  condition: eq(variables['JUMPBOX_HOST'], '')

# Private cluster: fetch kubeconfig on jumpbox via SSH
# Jumpbox uses Managed Identity for Azure authentication
- script: |
    set -euo pipefail
    
    # SSH_KEY_PATH is set by steps/ssh/setup-key.yml
    if [ -z "${SSH_KEY_PATH:-}" ] || [ ! -f "$SSH_KEY_PATH" ]; then
      echo "SSH_KEY_PATH is not set or file not found: ${SSH_KEY_PATH:-'(not set)'}" >&2
      exit 1
    fi
    
    ssh_target="${JUMPBOX_USERNAME}@${JUMPBOX_HOST}"
    ssh_opts=(-i "$SSH_KEY_PATH" -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null")
    
    region="${{ parameters.region }}"
    role="${{ parameters.role }}"
    
    echo "Fetching kubeconfig on jumpbox for AKS with role '$role' in region '$region'..."
    echo "Using SSH key: $SSH_KEY_PATH"/
    echo "Jumpbox: $ssh_target"
    
    # Use Managed Identity on jumpbox for Azure authentication
    ssh -tt "${ssh_opts[@]}" "$ssh_target" "set -euo pipefail && \
      echo 'Logging in with Managed Identity...' && \
      az login --identity --output none && \
      echo 'Login successful. Finding AKS cluster...' && \
      aks_name=\$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location '$region' \
        --query \"[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].name\" --output tsv) && \
      aks_rg=\$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location '$region' \
        --query \"[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].resourceGroup\" --output tsv) && \
      if [ -z \"\$aks_name\" ]; then echo 'No AKS found with run_id=${RUN_ID} and role=$role'; exit 1; fi && \
      echo \"Found AKS: \$aks_name in resource group: \$aks_rg\" && \
      mkdir -p ~/.kube && \
      az aks get-credentials -n \$aks_name -g \$aks_rg --file ~/.kube/config --overwrite-existing && \
      echo 'Kubeconfig updated on jumpbox. Testing kubectl...' && \
      kubectl get nodes" 2>&1
  displayName: "Update kubeconfig (via Jumpbox)"
  condition: ne(variables['JUMPBOX_HOST'], '')

