parameters:
- name: region
  type: string
- name: role
  type: string
- name: alias
  type: string
  default: ""

steps:
- ${{ if eq(variables['JUMPBOX_HOST'], '') }}:
  # Public cluster: fetch kubeconfig locally on agent
  - script: |
      set -euo pipefail
      set -x
      
      region=${{ parameters.region }}
      role=${{ parameters.role }}
      
      aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
        --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].name" --output tsv)

      aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
        --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].resourceGroup" --output tsv)

      if [ -z "$aks_name" ]; then
          echo "No AKS instance with role $role and tag $RUN_ID found in region $region."
          exit 1
      fi

      mkdir -p ~/.kube
      az aks get-credentials -n $aks_name -g $aks_rg --file ~/.kube/config
    env:
      ROLE: ${{ parameters.role }}
    displayName: "Update kubeconfig (local)"

- ${{ if ne(variables['JUMPBOX_HOST'], '') }}:
  # Private cluster: fetch kubeconfig on jumpbox via SSH
  - template: /steps/cloud/azure/run-on-jumpbox.yml
    parameters:
      displayName: "Update kubeconfig"
      script: |
        set -euo pipefail
        set -x
        
        region=${{ parameters.region }}
        role=${{ parameters.role }}
        
        aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
          --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].name" --output tsv)

        aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
          --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$role')].resourceGroup" --output tsv)

        if [ -z "$aks_name" ]; then
            echo "No AKS instance with role $role and tag $RUN_ID found in region $region."
            exit 1
        fi

        mkdir -p ~/.kube
        az aks get-credentials -n $aks_name -g $aks_rg --file ~/.kube/config
