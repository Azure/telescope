parameters:
- name: region
  type: string
- name: role
  type: string

steps:
- script: |
    set -euo pipefail
    set -x

    region=${{ parameters.region }}
    reuse_cluster=$(echo "${REUSE_CLUSTER:-false}" | tr '[:upper:]' '[:lower:]')
    
    # Use BASE_RUN_ID for cluster discovery when reusing, otherwise use RUN_ID
    if [ "$reuse_cluster" = "true" ]; then
      CLUSTER_RUN_ID="$BASE_RUN_ID"
      echo "Reusing cluster - searching with BASE_RUN_ID: $CLUSTER_RUN_ID"
    else
      CLUSTER_RUN_ID="$RUN_ID"
      echo "New cluster - searching with RUN_ID: $CLUSTER_RUN_ID"
    fi

    aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
      --query "[?(tags.run_id == '$CLUSTER_RUN_ID' && tags.role == '$ROLE')].name" --output tsv)

    aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
      --query "[?(tags.run_id == '$CLUSTER_RUN_ID' && tags.role == '$ROLE')].resourceGroup" --output tsv)

    if [ -z "$aks_name" ]; then
        echo "##vso[task.logissue type=error;] No AKS instance with role $ROLE and tag $CLUSTER_RUN_ID found in region $region."
        exit 1
    fi
    echo "Found cluster: $aks_name in resource group: $aks_rg"
    az aks get-credentials -n $aks_name -g $aks_rg
  env:
    ROLE: ${{ parameters.role }}
    REUSE_CLUSTER: $(reuse_cluster)
  displayName: "Update kubeconfig"
