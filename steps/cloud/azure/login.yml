parameters:
- name: region
  type: string
- name: subscription
  type: string
  default: $(AZURE_SUBSCRIPTION_ID)

steps:
- bash: |
    set -eu

    echo "login to Azure in $REGION"
    az login --identity --username $AZURE_MI_ID
    az account set --subscription "${AZURE_MI_SUBSCRIPTION_ID}"
    az config set defaults.location="$REGION"
  displayName: "Azure Login"
  env:
    AZURE_MI_ID: $(AZURE_MI_CLIENT_ID)
    AZURE_MI_SUBSCRIPTION_ID: ${{ parameters.subscription }}
    REGION: ${{ parameters.region }}
