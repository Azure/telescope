parameters:
- name: region
  type: string

steps:
- script: |
    set -euo pipefail
    set -x

    anonymous_pull="${ANONYMOUS_PULL:-true}"
    anonymous_pull="${anonymous_pull,,}"

    acr_name=""
    if [[ -n "$REGISTRY_ENDPOINT" ]]; then
        acr_name=$(az resource list --resource-type Microsoft.ContainerRegistry/registries \
          --name "${REGISTRY_ENDPOINT%%.*}" \
          --query "[0].name" --output tsv)
    fi

    [[ -n "$acr_name" ]] || exit 0

    acr_info=$(az acr show --name "$acr_name" --output json)
    anonymous_pull_enabled=$(echo "$acr_info" | jq -r '.anonymousPullEnabled')
    role_assignment_mode=$(echo "$acr_info" | jq -r '.roleAssignmentMode')

    if [[ "$anonymous_pull" == "true" ]]; then
      if [[ "$anonymous_pull_enabled" == "false" ]]; then
        echo "Enabling anonymous pull for ACR $acr_name"
        az acr update --name $acr_name --anonymous-pull-enabled true
      fi
    else
      if [[ "$role_assignment_mode" == "AbacRepositoryPermissions" ]]; then
        echo "Updating role assignment mode from rbac-abac to rbac for ACR $acr_name"
        az acr update --name $acr_name --role-assignment-mode "rbac"
      fi

      aks_name=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $REGION \
        --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$ROLE')].name" --output tsv
      aks_rg=$(az resource list --resource-type Microsoft.ContainerService/managedClusters --location $region \
        --query "[?(tags.run_id == '${RUN_ID}' && tags.role == '$ROLE')].resourceGroup" --output tsv)

      if [ -z "$aks_name" ]; then
        echo "##vso[task.logissue type=error;] No AKS instance with role $ROLE and tag $RUN_ID found in region $region."
        exit 1
      fi

      az aks update --name $aks_name --resource-group $RUN_ID --attach-acr $acr_name
    fi

  env:
    RUN_ID: $(RUN_ID)
    REGION: ${{ parameters.region }}
  displayName: "Authenticate ACR from AKS"
