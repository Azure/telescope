parameters:
- name: region
  type: string
- name: instance_type
  type: string
- name: instance_count
  type: string
- name: start_date
  type: string
- name: duration_hours
  type: string
- name: dry_run
  type: string
  default: "true"

steps:
- script: |
    set -eo pipefail

    ARGS=(
      "$PYTHON_SCRIPT_FILE"
      --region "$REGION"
      --instance-type "$INSTANCE_TYPE"
      --instance-count "$INSTANCE_COUNT"
      --start-date "$START_DATE"
      --duration-hours "$DURATION_HOURS"
    )
    if [[ "${DRY_RUN,,}" == "true" ]]; then
      ARGS+=(--dry-run)
    fi
    # Run the command
    PYTHONPATH=$PYTHONPATH:$(pwd) python3 "${ARGS[@]}"
  workingDirectory: modules/python
  env:
    REGION: ${{ parameters.region }}
    PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/cloud/aws/managers/capacity_reservation_manager.py
    INSTANCE_TYPE: ${{ parameters.instance_type }}
    INSTANCE_COUNT: ${{ parameters.instance_count }}
    START_DATE: ${{ parameters.start_date }}
    DURATION_HOURS: ${{ parameters.duration_hours }}
    DRY_RUN: ${{ parameters.dry_run }}
  displayName: "Create AWS Capacity Reservation"
