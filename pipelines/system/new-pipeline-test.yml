trigger: none

variables:
  # Pipeline variables with defaults - these will check for ADO pipeline variables first, then use defaults
  AZURE_SUBSCRIPTION_ID: $[coalesce(variables['AZURE_SUBSCRIPTION_ID'], '9b8218f9-902a-4d20-a65c-e98acec5362f')]
  SKIP_RESOURCE_MANAGEMENT: $[coalesce(variables['SKIP_RESOURCE_MANAGEMENT'], 'false')]
  AZURE_SERVICE_CONNECTION: $[coalesce(variables['AZURE_SERVICE_CONNECTION'], 'Azure-for-Telescope-internal')]
  AZURE_STORAGE_ACCOUNT_NAME: $[coalesce(variables['AZURE_STORAGE_ACCOUNT_NAME'], 'akstelescope')]
  AZURE_TELESCOPE_STORAGE_ACCOUNT_NAME: $[coalesce(variables['AZURE_TELESCOPE_STORAGE_ACCOUNT_NAME'], 'telescopedata')]
  LOCATION: $[coalesce(variables['LOCATION'], 'uksouth')]
  CREATESWIFTV2PING: $[coalesce(variables['CREATESWIFTV2PING'], 'true')]
  CLEANUP_RESOURCES: $[coalesce(variables['CLEANUP_RESOURCES'], 'true')]
  K8S_VERSION: $[coalesce(variables['K8S_VERSION'], '1.32')]
  # Scenario variables with defaults
  SCENARIO_TYPE: $[coalesce(variables['SCENARIO_TYPE'], 'perf-eval')]
  SCENARIO_NAME: $[coalesce(variables['SCENARIO_NAME'], 'swiftv2')]
  OWNER: $[coalesce(variables['OWNER'], 'aks')]
  # Common matrix parameters
  cpu_per_node: 4
  max_pods: 1
  repeats: 1
  node_label: "slo=true"
  cilium_enabled: False
  scrape_containerd: False
  service_test: False
  ds_test: True

stages:
  - stage: generate_base_run_id
    displayName: 'Generate Base Run ID'
    jobs:
    - job: generate_run_id
      displayName: 'Generate Base Run ID'
      steps:
      - script: |
          # Generate base run ID: Initials-DDHHMMSS (17 chars total with job suffix)
          timestamp=$(date +%d%H%M%S)
          
          # Extract user initials from Build.RequestedFor (e.g., "John Doe" -> "JD")
          user_name="$(Build.RequestedFor)"
          echo "Pipeline triggered by: $user_name"
          
          # Extract initials - get first letter of each word, convert to uppercase, take first 2
          user_initials=$(echo "$user_name" | sed 's/[^A-Za-z ]//g' | awk '{for(i=1;i<=NF;i++) printf substr(toupper($i),1,1)}' | cut -c1-2)
          
          # Fallback if initials are empty or too short
          if [ -z "$user_initials" ] || [ ${#user_initials} -lt 2 ]; then
            user_initials="XX"
          fi
          
          base_run_id="${user_initials}-${timestamp}"
          echo "Generated timestamp: $timestamp"
          echo "User initials: $user_initials"
          echo "Generated base run ID: $base_run_id"
          echo "##vso[task.setvariable variable=BASE_RUN_ID;isOutput=true]$base_run_id"
        name: generate_id
        displayName: "Generate Base Run ID"

  - stage: dynamicres_gradual
    displayName: 'Dynamic Gradual'
    dependsOn: generate_base_run_id
    variables:
      BASE_RUN_ID: $[ stageDependencies.generate_base_run_id.generate_run_id.outputs['generate_id.BASE_RUN_ID'] ]
    jobs:
      - template: /pipelines/system/matrices/swiftv2-dynamicres-gradual-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2-ds-churn
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          base_run_id: $(BASE_RUN_ID)

  - stage: dynamicres_burst
    displayName: 'Dynamic Burst'
    condition: false
    dependsOn: generate_base_run_id
    variables:
      BASE_RUN_ID: $[ stageDependencies.generate_base_run_id.generate_run_id.outputs['generate_id.BASE_RUN_ID'] ]
    jobs:
      - template: /pipelines/system/matrices/swiftv2-dynamicres-burst-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2-ds-churn
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          base_run_id: $(BASE_RUN_ID)

  - stage: staticres_gradual
    displayName: 'Static Gradual'
    dependsOn: generate_base_run_id
    variables:
      BASE_RUN_ID: $[ stageDependencies.generate_base_run_id.generate_run_id.outputs['generate_id.BASE_RUN_ID'] ]
    jobs:
      - template: /pipelines/system/matrices/swiftv2-staticres-gradual-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2-ds-churn
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          base_run_id: $(BASE_RUN_ID)

  - stage: staticres_burst
    displayName: 'Static Burst'
    condition: false
    dependsOn: generate_base_run_id
    variables:
      BASE_RUN_ID: $[ stageDependencies.generate_base_run_id.generate_run_id.outputs['generate_id.BASE_RUN_ID'] ]
    jobs:
      - template: /pipelines/system/matrices/swiftv2-staticres-burst-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2-ds-churn
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          base_run_id: $(BASE_RUN_ID)