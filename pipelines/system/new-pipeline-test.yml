trigger: none

variables:
  # Cleanup control - set to false to keep resources after pipeline completes
  CLEANUP: "true"
  # Slow delete - when true, runs the swiftv2 workload cleanup script for graceful deletion
  # This is slower but ensures proper cleanup of deployments, pods, and PNIs before nodepool deletion
  SLOW_DELETE: "false"
  
  # Hardcoded ADO pipeline variables
  AZURE_SUBSCRIPTION_ID: "37deca37-c375-4a14-b90a-043849bd2bf1"
  SKIP_RESOURCE_MANAGEMENT: "false"
  AZURE_SERVICE_CONNECTION: "Azure-for-Telescope-internal"
  AZURE_STORAGE_ACCOUNT_NAME: "akstelescope"
  AZURE_TELESCOPE_STORAGE_ACCOUNT_NAME: "telescopedata"
  LOCATION: "uksouth"
  CREATESWIFTV2PING: "true"
  K8S_VERSION: "1.33"
  PROVISION_BUFFER_NODES: "false"
  # Log Analytics are expensive - disable and delete after use
  # WARNING: Enabling Log Analytics adds +1 DaemonSet pod per node - increase max_pods by 1 if enabled
  ENABLE_LOG_ANALYTICS: "false"
  # Existing scenario variables
  SCENARIO_TYPE: perf-eval
  SCENARIO_NAME: swiftv2-cluster-churn-feature
  OWNER: aks
  VM_SKU: Standard_D16s_v4
  # count of swiftv2 pods/NIC per step
  PODS_PER_NODE: 7
  DEVICE_PLUGIN: "false"
  PROBE_TARGET_URL: "http://172.27.0.30/"
  PROBE_TIMEOUT: "300"
  
  # Container images - Using centralized ACR (acndev)
  DATAPATH_REPORTER_IMAGE: "acndev.azurecr.io/datapath-reporter:2026.01.18.01"
  NGINX_IMAGE: "acndev.azurecr.io/nginx:latest"
  
  # Image pre-pull batching configuration
  IMAGE_PREPULL_BATCH_SIZE: "100"

  # CL2 parameters
  cpu_per_node: 16
  # max_pods = PODS_PER_NODE + default k8s system pods (5) + azuresecuritylinuxagent (1) + log analytics pod (1 if ENABLE_LOG_ANALYTICS=true)
  # Current: 7 + 5 + 1 = 13 (increase to 14 if enabling Log Analytics)
  max_pods: 13
  # Common matrix parameters
  repeats: 1
  node_label: "swiftv2slo=true"
  cilium_enabled: False
  scrape_containerd: False
  service_test: False
  ds_test: True

stages:
  - stage: staticres_gradual
    displayName: 'Static Gradual'
    jobs:
      - job: generate_run_id
        displayName: 'Generate Run ID'
        steps:
        - template: /steps/generate-run-id.yml
          parameters:
            prefix: sg
      - template: /pipelines/system/matrices/swiftv2-staticres-gradual-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          dependsOn:
            - generate_run_id
      - template: /jobs/cleanup.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          credential_type: service_connection
          dependsOn:
            - generate_run_id
            - azure

  - stage: dynamicres_gradual
    condition: succeededOrFailed()
    displayName: 'Dynamic Gradual'
    dependsOn: 
      - staticres_gradual
    jobs:
      - job: generate_run_id
        displayName: 'Generate Run ID'
        steps:
        - template: /steps/generate-run-id.yml
          parameters:
            prefix: dg
      - template: /pipelines/system/matrices/swiftv2-dynamicres-gradual-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          dependsOn:
            - generate_run_id
      - template: /jobs/cleanup.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          credential_type: service_connection
          dependsOn:
            - generate_run_id
            - azure

  - stage: staticres_burst
    condition: false
    displayName: 'Static Burst'
    jobs:
      - job: generate_run_id
        displayName: 'Generate Run ID'
        steps:
        - template: /steps/generate-run-id.yml
          parameters:
            prefix: sb
      - template: /pipelines/system/matrices/swiftv2-staticres-burst-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          dependsOn:
            - generate_run_id
      - template: /jobs/cleanup.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          credential_type: service_connection
          dependsOn:
            - generate_run_id
            - azure
          
  - stage: dynamicres_burst
    condition: false
    displayName: 'Dynamic Burst'
    jobs:
      - job: generate_run_id
        displayName: 'Generate Run ID'
        steps:
        - template: /steps/generate-run-id.yml
          parameters:
            prefix: db
      - template: /pipelines/system/matrices/swiftv2-dynamicres-burst-matrix.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          engine: clusterloader2
          engine_input:
            image: "ghcr.io/azure/clusterloader2:v20250311"
          topology: swiftv2
          max_parallel: 1
          timeout_in_minutes: 2160
          credential_type: service_connection
          ssh_key_enabled: false
          dependsOn:
            - generate_run_id
      - template: /jobs/cleanup.yml
        parameters:
          cloud: azure
          regions:
            - $(LOCATION)
          credential_type: service_connection
          dependsOn:
            - generate_run_id
            - azure
