trigger: none
schedules:
- cron: "0 0 * * *"
  displayName: "12:00 AM daily (small scale)"
  branches:
    include:
    - main
  always: true
- cron: "0 12 * * 1,3"
  displayName: "12:00 PM on Mondays and Wednesdays (medium scale)"
  branches:
    include:
    - main
  always: true
- cron: "0 12 * * 4"
  displayName: "12:00 PM on Thursdays (high scale)"
  branches:
    include:
    - main
  always: true
variables:
  SCENARIO_TYPE: perf-eval
  SCENARIO_NAME: k8s-ray-scheduling

stages:
- stage: azure_eastus2_ray_small
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '12:00 AM daily (small scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20251020"
      topology: kwok
      matrix:
        small:
          node_count: 100
          job_count: 100
          job_throughput: 100
          scale_timeout: "30m"
          node_gpu: 4
          job_gpu: 1
          enable_dra: false
          ray_enabled: true
          job_template_path: ray/job_template.yaml
          cl2_config_file: ray/config.yaml
      max_parallel: 1
      timeout_in_minutes: 60
      credential_type: service_connection
      ssh_key_enabled: false

- stage: azure_eastus2_ray_medium
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '12:00 PM on Mondays and Wednesday (medium scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20251020"
      topology: kwok
      matrix:
        medium:
          node_count: 1000
          job_throughput: 100
          job_count: 1000
          scale_timeout: "45m"
          node_gpu: 4
          job_gpu: 1
          enable_dra: false
          ray_enabled: true
          job_template_path: ray/job_template.yaml
          cl2_config_file: ray/config.yaml
      max_parallel: 1
      timeout_in_minutes: 120
      credential_type: service_connection
      ssh_key_enabled: false

- stage: azure_eastus2_ray_high
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '12:00 PM on Thursdays (high scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20251020"
      topology: kwok
      matrix:
        high:
          node_count: 5000
          job_throughput: 100
          job_count: 5000
          scale_timeout: "1h"
          node_gpu: 4
          job_gpu: 1
          enable_dra: false
          ray_enabled: true
          job_template_path: ray/job_template.yaml
          cl2_config_file: ray/config.yaml
      max_parallel: 1
      timeout_in_minutes: 120
      credential_type: service_connection
      ssh_key_enabled: false
