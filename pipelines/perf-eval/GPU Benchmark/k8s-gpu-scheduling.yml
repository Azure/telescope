trigger: none
schedules:
- cron: "0 4 * * *"
  displayName: "4:00 AM daily (small scale)"
  branches:
    include:
    - main
  always: true
- cron: "0 16 * * 1,3"
  displayName: "4:00 PM on Mondays and Wednesday (medium scale)"
  branches:
    include:
    - main
  always: true
- cron: "0 16 * * 4"
  displayName: "4:00 PM on Thursdays (high scale)"
  branches:
    include:
    - main
  always: true
variables:
  SCENARIO_TYPE: perf-eval
  SCENARIO_NAME: k8s-gpu-scheduling

stages:
- stage: azure_eastus2_gpu_small
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '4:00 AM daily (small scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20250513"
      topology: kwok
      matrix:
        small:
          node_count: 200
          job_count: 2000
          job_throughput: 100
          scale_timeout: "30m"
          cl2_config_file: config.yaml
          node_gpu: 8
          job_gpu: 8
          job_template_path: gpu/job_template.yaml
      max_parallel: 1
      timeout_in_minutes: 60
      credential_type: service_connection
      ssh_key_enabled: false

- stage: azure_eastus2_gpu_medium
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '4:00 PM on Mondays and Wednesday (medium scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20250513"
      topology: kwok
      matrix:
        medium:
          node_count: 1000
          job_throughput: 500
          job_count: 10000
          scale_timeout: "45m"
          cl2_config_file: config.yaml
          node_gpu: 8
          job_gpu: 8
          job_template_path: gpu/job_template.yaml
      max_parallel: 1
      timeout_in_minutes: 120
      credential_type: service_connection
      ssh_key_enabled: false

- stage: azure_eastus2_gpu_high
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '4:00 PM on Thursdays (high scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20250513"
      topology: kwok
      matrix:
        high:
          node_count: 2000
          job_throughput: 800
          job_count: 20000
          scale_timeout: "1h"
          cl2_config_file: config.yaml
          node_gpu: 8
          job_gpu: 8
          job_template_path: gpu/job_template.yaml
      max_parallel: 1
      timeout_in_minutes: 120
      credential_type: service_connection
      ssh_key_enabled: false

- stage: azure_eastus2_dra_small
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '4:00 AM daily (small scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20250513"
      topology: kwok
      matrix:
        small:
          node_count: 200
          job_count: 2000
          job_throughput: 100
          scale_timeout: "30m"
          cl2_config_file: config.yaml
          node_gpu: 8
          enable_dra: true
          job_template_path: dra/job_template.yaml
      max_parallel: 1
      timeout_in_minutes: 60
      credential_type: service_connection
      ssh_key_enabled: false

- stage: azure_eastus2_dra_medium
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '4:00 PM on Mondays and Wednesday (medium scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20250513"
      topology: kwok
      matrix:
        medium:
          node_count: 1000
          job_throughput: 500
          job_count: 10000
          scale_timeout: "45m"
          cl2_config_file: config.yaml
          node_gpu: 8
          enable_dra: true
          job_template_path: dra/job_template.yaml
      max_parallel: 1
      timeout_in_minutes: 120
      credential_type: service_connection
      ssh_key_enabled: false

- stage: azure_eastus2_dra_high
  dependsOn: []
  condition: or(and(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.CronSchedule.DisplayName'], '4:00 PM on Thursdays (high scale)')), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: /jobs/competitive-test.yml
    parameters:
      cloud: azure
      regions:
      - eastus2
      engine: clusterloader2
      engine_input:
        image: "ghcr.io/azure/clusterloader2:v20250513"
      topology: kwok
      matrix:
        high:
          node_count: 2000
          job_throughput: 800
          job_count: 20000
          scale_timeout: "1h"
          cl2_config_file: config.yaml
          node_gpu: 8
          enable_dra: true
          job_template_path: dra/job_template.yaml
      max_parallel: 1
      timeout_in_minutes: 120
      credential_type: service_connection
      ssh_key_enabled: false